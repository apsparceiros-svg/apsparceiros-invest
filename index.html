<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium (Tela Cheia)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f0f;
  --muted:#9e9e9e;
  --gold:#c9a84b;
  --card:#121212;
  --accent:#e6e6e6;
}
/* ===== Ajustes gerais ===== */
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent);margin:0;padding:0}
html,body{
  height:100%;
  width:100%;
  overflow:hidden;
  background:linear-gradient(180deg,#040404,#0a0a0a);
  -webkit-font-smoothing:antialiased;
  font-size:17px;
  transform-origin: top left;
  transform: scale(1.00);
}
/* ===== Cabeçalho ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:20px 28px;
  border-bottom:1px solid rgba(255,255,255,0.04);
}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px;font-size:20px}
.header .meta{color:var(--muted);font-size:14px}
/* ===== Container full screen ===== */
.container{
  display:flex;
  height:calc(100vh - 72px);
  width:100%;
  gap:28px;
  padding:28px;
  overflow:hidden;
}
.sidebar{
  width:22%;
  min-width:300px;
  background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));
  border-radius:12px;
  padding:18px;
  overflow-y:auto;
  scrollbar-width:thin;
}
.content{
  flex:1;
  background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));
  border-radius:12px;
  padding:22px;
  overflow-y:auto;
  scrollbar-width:thin;
}
.section-title{font-weight:700;color:var(--gold);margin-bottom:10px}
.small{font-size:13px;color:var(--muted)}
/* ===== Cartões e inputs ===== */
.project-card{
  background:var(--card);
  padding:14px;
  border-radius:10px;
  margin-bottom:14px;
  display:flex;
  gap:12px;
  flex-direction:column;
  border:1px solid rgba(255,255,255,0.03);
  cursor:pointer;
}
.project-card .info{flex:1;width:100%}
.kpi{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
.kpi .item{
  background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));
  padding:10px;
  border-radius:8px;
  min-width:90px;
  text-align:center
}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color:#1e1e1e;
    color:#fff;
    border:1px solid #c9a84b;
    padding:8px;
    border-radius:6px;
    width:100%;
    margin-bottom:6px;
}
.project-card input:focus{outline:2px solid #c9a84b;background-color:#292929}
.button{
  background:var(--gold);
  color:#0b0b0b;
  border:none;
  padding:10px 14px;
  border-radius:8px;
  cursor:pointer;
  font-weight:700;
}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--accent)}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));
  padding:14px;
  border-radius:10px;
  margin-bottom:14px;
  border:1px solid rgba(255,255,255,0.03)
}
/* ===== Tooltip ===== */
.tooltip{position:relative;display:inline-block}
.tooltip .tt{
  visibility:hidden;
  width:260px;
  background:#0c0c0c;
  color:var(--muted);
  text-align:left;
  border-radius:6px;
  padding:10px;
  position:absolute;
  z-index:10;
  bottom:130%;
  left:50%;
  transform:translateX(-50%);
  opacity:0;
  transition:opacity .12s;
}
.tooltip:hover .tt{visibility:visible;opacity:1}
/* ===== Gráficos maiores ===== */
#chartPortfolio, #chartFluxo, #chartReceitas, #chartCustos {
  min-height:360px;
}
/* ===== Modal de detalhes ===== */
#detailModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-inner {
  width: 94%;
  max-width: 1200px;
  max-height: 92vh;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border-radius: 14px;
  padding: 20px;
  border:1px solid rgba(255,255,255,0.05);
  overflow:auto;
  position: relative;
}
.modal-close {
  position: absolute;
  right: 16px;
  top: 14px;
  background: transparent;
  border: none;
  color: var(--gold);
  font-size: 22px;
  cursor: pointer;
}
.modal-tabs { display:flex; gap:10px; margin-bottom:14px; }
.tab-btn {
  background:transparent;
  border:1px solid rgba(255,255,255,0.04);
  padding:8px 14px;
  border-radius:8px;
  color:var(--accent);
  cursor:pointer;
}
.tab-btn.active { background:var(--gold); color:#0b0b0b; border-color:var(--gold) }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; margin-top:12px }
.stat { background:var(--card); padding:12px; border-radius:8px; border:1px solid rgba(255,255,255,0.02) }
@media(max-width:1100px){
  html,body{transform:scale(1);overflow:auto}
  .container{flex-direction:column;padding:18px;gap:18px;height:auto}
  .sidebar{width:auto;min-width:unset}
}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:28px;border-radius:12px;width:420px;border:1px solid rgba(255,255,255,0.05);box-shadow:0 0 15px rgba(201,168,75,0.4);transition:all 0.3s ease" id="loginBox">
    <h2 style="margin-top:0;color:var(--gold);text-align:center">Acesso Premium</h2>
    <p class="small" style="margin-bottom:16px;text-align:center;color:var(--muted)">Digite a senha para desbloquear o painel completo</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--accent);transition:border 0.2s, box-shadow 0.2s">
    <div style="display:flex;gap:8px;margin-top:18px;justify-content:flex-end">
      <button id="btnLogin" class="button" style="flex:1">Entrar</button>
    </div>
    <p class="small" style="margin-top:12px;color:var(--muted);text-align:center">
  Esqueceu a senha? 
  <a href="https://wa.me/5512997036301?text=Olá!%20Preciso%20de%20ajuda%20para%20acessar%20o%20painel%20APSPARCEIROS%20Invest."
     target="_blank" 
     style="color:var(--gold);text-decoration:none;font-weight:700">
    Entre em contato!
  </a>
</p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por indicador</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label class="small">Mostrar</label>
        <select id="showIndicators"><option value="all">Todos</option><option value="vgv">VGV</option><option value="irr">TIR</option></select>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0">

        <div><strong>Condições de Venda</strong></div>
        <label>Desconto Pré-lançamento (%)</label>
        <input id="discountPre" type="number" min="0" max="100" step="0.1" value="10">
        <label>Meses Pré-lançamento</label>
        <input id="preLaunchMonths" type="number" min="1" step="1" value="2">

        <label>Desconto Lançamento (%)</label>
        <input id="discountLaunch" type="number" min="0" max="100" step="0.1" value="5">
        <label>Meses Lançamento</label>
        <input id="launchMonths" type="number" min="1" step="1" value="3">

        <label>Pagamento no ato (%)</label>
        <input id="payAtoPct" type="number" min="0" max="100" step="0.1" value="0">

        <label>Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">

        <label>Parcelas da entrada (nº)</label>
        <input id="entradaMonths" type="number" min="1" step="1" value="6">

        <label>Pagamento intermediário (%)</label>
        <input id="payInterPct" type="number" min="0" max="100" step="0.1" value="0">

        <label>Mês do pagamento intermediário (após venda)</label>
        <input id="payInterMonth" type="number" min="0" step="1" value="6">

        <label>Parcelas do saldo (nº)</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">

        <label>Pagamento na entrega das chaves (%)</label>
        <input id="payChavesPct" type="number" min="0" max="100" step="0.1" value="0">

        <label>Correção INCC (mensal, ex.: 0.0045)</label>
        <input id="incc" type="number" min="0" step="0.0001" value="0.0045">
        
        <label>Correção IPCA (mensal, ex.: 0.005)</label>
        <input id="ipca" type="number" min="0" step="0.0001" value="0.005">

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0">

        <div><strong>Parâmetros Adicionais</strong></div>

        <label>Comissão (% sobre vendas)</label>
        <input id="brokerPct" type="number" min="0" max="100" step="0.1" value="5">

        <label>Impostos sobre Receita (%)</label>
        <input id="taxesPct" type="number" min="0" max="100" step="0.1" value="6">

        <label>Provisão de Contingência (%)</label>
        <input id="contingencyPct" type="number" min="0" max="100" step="0.1" value="3">

        <label>Custo do Terreno (% VGV)</label>
        <input id="landPct" type="number" min="0" max="100" step="0.1" value="8">

        <div style="margin-top:8px;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input id="applyProjection" type="checkbox" style="width:auto;cursor:pointer">
         Aplicar projeção INCC/IPCA aos valores de venda
        </label>
      </div>

        <div class="small" style="margin-top:6px">
        Os parâmetros adicionais impactam diretamente ROI, TIR, fluxo e VGV ajustado.
      </div>


        <div class="small" style="margin-top:6px">A entrada é paga em X parcelas a partir do mês da venda; o restante (saldo) é pago em Y parcelas subsequentes. Pagamentos intermediários e pagamento na entrega das chaves são aplicados por unidade vendida.</div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <div style="height:auto; min-height:120px;">
                <canvas id="chartPortfolio" style="width:100%;height:auto;"></canvas>
              </div>
            </div>
            <div style="width:220px">
              <div class="kpi">
                <div class="item"><div class="small">ROI médio</div><div class="value" id="avgRoi">--</div></div>
                <div class="item"><div class="small">TIR média</div><div class="value" id="avgIrr">--</div></div>
              </div>
              <div style="margin-top:10px" class="small">Clique num projeto no menu lateral para ver detalhes.</div>
            </div>
          </div>
        </div>

        <div id="detailArea" style="display:none"></div>
      </section>

      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table style="width:100%"><tbody>
            <tr><td class="small">VGV</td><td class="small">Valor Geral de Vendas</td></tr>
            <tr><td class="small">ROI</td><td class="small">Retorno sobre o capital</td></tr>
            <tr><td class="small">TIR</td><td class="small">Taxa interna de retorno</td></tr>
            <tr><td class="small">Payback</td><td class="small">Meses para recuperar investimento</td></tr>
          </tbody></table>
        </div>

        <div class="card">
          <div class="section-title">Cap Table (exemplo)</div>
          <div class="small">Incorporador: 50%<br>Terrenista: 20%<br>Investidores: 30%</div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- ================= Modal de detalhes ================= -->
<div id="detailModal">
  <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-header" style="display:flex;flex-direction:column;align-items:center;gap:6px">
      <div style="width:100%;display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 id="modalTitle" style="margin:0;color:var(--gold)"></h3>
          <div class="small" id="modalCity" style="margin-top:4px;color:var(--muted)"></div>
        </div>
        <button class="modal-close" id="closeModal" title="Fechar">✕</button>
      </div>
      <div style="width:100%;display:flex;justify-content:center;align-items:center;gap:6px">
        <div class="small">VGV</div>
        <div style="font-weight:800;color:var(--gold)" id="modalVgv"></div>
      </div>
    </div>

    <div class="modal-tabs" id="modalTabs">
      <button class="tab-btn active" data-tab="fluxo">Fluxo Líquido</button>
      <button class="tab-btn" data-tab="receitas">Receitas</button>
      <button class="tab-btn" data-tab="custos">Custos</button>
    </div>

    <div class="modal-charts">
      <div class="canvas-wrap" id="wrapFluxo" style="display:block">
        <canvas id="chartFluxo" style="width:100%;height:240px;"></canvas>
      </div>
      <div class="canvas-wrap" id="wrapReceitas" style="display:none">
        <canvas id="chartReceitas" style="width:100%;height:240px;"></canvas>
      </div>
      <div class="canvas-wrap" id="wrapCustos" style="display:none">
        <canvas id="chartCustos" style="width:100%;height:240px;"></canvas>
      </div>

      <div class="stats-grid" id="modalStats" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>

// ---------- Dados iniciais (exemplo) ----------
let projects = [
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,pre_launch_sales:2,launch_sales:4,monthly_sales:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,pre_launch_sales:1,launch_sales:3,monthly_sales:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,pre_launch_sales:3,launch_sales:5,monthly_sales:4}
];
const PASSWORD = "Investidor";
const colors = ['#c9a84b','#b58f3a','#d9b86b','#8bc34a','#2196f3','#9c27b0'];

// ---------- Configurações persistentes e realismo financeiro ----------
const cfgKey = 'aps_sale_cfg_v2';
let saleCfg = {
  discountPre:10,
  discountLaunch:5,
  parcelasRestantes:24,
  entradaPct:30,
  entradaMonths:6,
  payAtoPct: 0,
  payInterPct: 0,
  payInterMonth: 6,
  payChavesPct: 0,
  preLaunchMonths:2,
  launchMonths:3,
  incc:0.0045,              // índice obra mensal
  ipca:0.005,               // índice pós-obra mensal
  applyProjection: false,
  // parâmetros "realistas" adicionais (padrões razoáveis)
  brokerPct:0.05,           // comissão total sobre receitas (padrão 5%)
  taxesPct:0.06,            // impostos sobre receita (ISS + outros) exemplo 6%
  contingencyPct:0.03,      // contingência sobre custo de obra
  landPct:0.08              // custo do terreno como pct do VGV (apenas se desejado)
};

// Carrega configuração para inputs existentes sem quebrar se inputs novos não existirem
function loadCfg(){
  const s = localStorage.getItem(cfgKey);
  if(s) try { saleCfg = Object.assign(saleCfg, JSON.parse(s)); } catch(e){}
  // campos conhecidos do HTML original — se existirem, preenche
  ['discountPre','discountLaunch','parcelasRestantes','entradaPct','entradaMonths','preLaunchMonths','launchMonths','incc','ipca','payAtoPct','payInterPct','payInterMonth','payChavesPct']
    .forEach(id => {
      const el = document.getElementById(id);
      if(el && typeof saleCfg[id] !== 'undefined') el.value = saleCfg[id];
    });
}

function saveCfg(){
  const tmp = {
    discountPre: Number(document.getElementById('discountPre')?.value) || saleCfg.discountPre,
    discountLaunch: Number(document.getElementById('discountLaunch')?.value) || saleCfg.discountLaunch,
    parcelasRestantes: Math.max(1, Math.floor(Number(document.getElementById('parcelasRestantes')?.value) || saleCfg.parcelasRestantes)),
    entradaPct: Math.min(100, Math.max(0, Number(document.getElementById('entradaPct')?.value) || saleCfg.entradaPct)),
    entradaMonths: Math.max(1, Math.floor(Number(document.getElementById('entradaMonths')?.value) || saleCfg.entradaMonths)),
    preLaunchMonths: Math.max(1, Math.floor(Number(document.getElementById('preLaunchMonths')?.value) || saleCfg.preLaunchMonths)),
    launchMonths: Math.max(1, Math.floor(Number(document.getElementById('launchMonths')?.value) || saleCfg.launchMonths)),
    incc: Number(document.getElementById('incc')?.value) || saleCfg.incc,
    ipca: Number(document.getElementById('ipca')?.value) || saleCfg.ipca,
    payAtoPct: Math.min(100, Math.max(0, Number(document.getElementById('payAtoPct')?.value) || saleCfg.payAtoPct)),
    payInterPct: Math.min(100, Math.max(0, Number(document.getElementById('payInterPct')?.value) || saleCfg.payInterPct)),
    payInterMonth: Math.max(0, Math.floor(Number(document.getElementById('payInterMonth')?.value) || saleCfg.payInterMonth)),
    payChavesPct: Math.min(100, Math.max(0, Number(document.getElementById('payChavesPct')?.value) || saleCfg.payChavesPct)),
    // valores adicionais mais "realistas" (não presentes no layout original)
    brokerPct: saleCfg.brokerPct,
    taxesPct: saleCfg.taxesPct,
    contingencyPct: saleCfg.contingencyPct,
    landPct: saleCfg.landPct
  };
  const soma = tmp.payAtoPct + tmp.payInterPct + tmp.payChavesPct + tmp.entradaPct;
  if(soma > 100) console.warn(`Soma dos percentuais (${soma}%) excede 100% — o restante será tratado como 0%.`);
  Object.assign(saleCfg, tmp);
  localStorage.setItem(cfgKey, JSON.stringify(saleCfg));
  renderSidebar();
}

// ---------- Utilitárias ----------
function ensureLen(arr, len){
  const safeLen = Math.max(0, Math.floor(len));
  while(arr.length < safeLen) arr.push(0);
}
function addToArrayAt(arr, idx, value){
  const i = Math.max(0, Math.floor(idx));
  ensureLen(arr, i+1);
  arr[i] += value;
}
function indexarValor(valor, taxaMensal, meses){
  return valor * Math.pow(1 + (taxaMensal||0), Math.max(0, meses));
}

// ---------- IRR robusto ----------
function irr(values, guess = 0.01) {
  if (!Array.isArray(values) || values.length === 0) return NaN;
  const hasPositive = values.some(v => v > 0);
  const hasNegative = values.some(v => v < 0);
  if (!hasPositive || !hasNegative) return NaN;
  // NPV function
  const npv = (r) => values.reduce((s,v,i)=>s+v/Math.pow(1+r,i),0);
  // Newton-Raphson with fallback to bisection
  let x0 = guess;
  for(let i=0;i<200;i++){
    const f0 = npv(x0);
    const h = 1e-6;
    const f1 = npv(x0 + h);
    const df = (f1 - f0) / h;
    if(Math.abs(df) < 1e-12) break;
    const x1 = x0 - f0/df;
    if(!isFinite(x1)) break;
    if(Math.abs(x1-x0) < 1e-9) return x1;
    x0 = x1;
  }
  // bisection search
  let low = -0.9999, high = 10;
  let fLow = npv(low), fHigh = npv(high);
  if(fLow * fHigh > 0) return NaN;
  for(let i=0;i<200;i++){
    const mid = (low + high)/2;
    const fMid = npv(mid);
    if(Math.abs(fMid) < 1e-7) return mid;
    if(fLow * fMid <= 0){ high = mid; fHigh = fMid; } else { low = mid; fLow = fMid; }
  }
  return (low + high)/2;
}

// ---------- Função principal de cálculo do projeto (mais realista) ----------
function computeProject(p) {
  const cfg = saleCfg;
  const price_unit_nominal = p.area * p.price_m2; // preço base por unidade
  const VGV = p.units * price_unit_nominal;      // valor geral de vendas (nominal)
  const totalConstruction = p.units * p.area * p.cost_m2; // custo direto da obra (nominal)

  // percentuais/fatores
  const pctAto = (cfg.payAtoPct || 0) / 100;
  const pctInter = (cfg.payInterPct || 0) / 100;
  const pctChaves = (cfg.payChavesPct || 0) / 100;
  const pctEntrada = (cfg.entradaPct || 0) / 100;
  const entradaMonths = Math.max(1, Math.floor(cfg.entradaMonths || 1));
  const restParc = Math.max(1, Math.floor(cfg.parcelasRestantes || 24));
  const incc = Number(cfg.incc || 0.0045);
  const ipca = Number(cfg.ipca || 0.005);
  const brokerPct = Number(cfg.brokerPct || 0.05);
  const taxesPct = Number(cfg.taxesPct || 0.06);
  const contingencyPct = Number(cfg.contingencyPct || 0.03);
  const landPct = Number(cfg.landPct || 0.08);

  // projCorrMes: corrige preço de venda por índice quando applyProjection=true
  function projCorrMes(originalPrice, saleMonth) {
    if (!cfg.applyProjection) return originalPrice;
    // antes da entrega aplicamos INCC; após entrega aplicamos IPCA
    const monthsUntilDelivery = Math.max(0, p.months - saleMonth);
    if (saleMonth < p.months) {
      return originalPrice * Math.pow(1 + incc, saleMonth);
    } else {
      // venda pós-obra: todo o período de obra mais o tempo pós-obra
      return originalPrice * Math.pow(1 + incc, p.months) * Math.pow(1 + ipca, saleMonth - p.months);
    }
  }

  // arrays de receitas
  const receiptsPre = [];
  const receiptsLaunch = [];
  const receiptsMonthly = [];

  function addReceipt(arr, month, value) {
    const m = Math.max(0, Math.floor(month));
    if (!value || value === 0) return;
    while (arr.length <= m) arr.push(0);
    arr[m] += value;
  }

  // Distribui parcelamento de uma unidade — recebimentos iniciam a partir do mês seguinte à venda
  function distributeUnit(saleMonth, price_unit, targetArray) {
    // calc preço ajustado por índice conforme mês de venda
    const adjustedPrice = projCorrMes(price_unit, saleMonth);

    // pagamento no ato (recebido no mês seguinte para evitar reconhecer no mês da venda)
    if (pctAto > 0) addReceipt(targetArray, saleMonth + 1, adjustedPrice * pctAto);

    // pagamento intermediário (em payInterMonth meses após venda)
    if (pctInter > 0) addReceipt(targetArray, saleMonth + 1 + (cfg.payInterMonth || 0), adjustedPrice * pctInter);

    // pagamento de chaves na entrega (mês p.months)
    if (pctChaves > 0) addReceipt(targetArray, p.months, adjustedPrice * pctChaves);

    // entrada parcelada: começa mês seguinte à venda
    if (pctEntrada > 0) {
      const parcela = (adjustedPrice * pctEntrada) / entradaMonths;
      for (let m = 0; m < entradaMonths; m++) addReceipt(targetArray, saleMonth + 1 + m, parcela);
    }

    // saldo restante parcelado a partir do mês seguinte ao fim da entrada
    let restantePct = 1 - (pctAto + pctInter + pctChaves + pctEntrada);
    restantePct = Math.max(0, restantePct);
    const saldoTotal = adjustedPrice * restantePct;
    if (restParc > 0 && saldoTotal > 0) {
      const saldoParc = saldoTotal / restParc;
      const startSaldoMonth = saleMonth + 1 + entradaMonths;
      for (let m = 0; m < restParc; m++) addReceipt(targetArray, startSaldoMonth + m, saldoParc);
    }
  }

  // distribui vendas uniformemente no período informado
  function distributeUnits(units, startMonth, periodMonths, discount = 0, targetArray) {
    units = Math.max(0, Math.floor(units || 0));
    periodMonths = Math.max(1, Math.floor(periodMonths || 1));
    // preço unitário com desconto aplicado — desconto é sobre preço nominal
    const price_unit = price_unit_nominal * (1 - (discount || 0) / 100);
    for (let u = 0; u < units; u++) {
      // distribui ao longo do período de forma uniforme
      const monthOffset = Math.floor(u * periodMonths / Math.max(1, units));
      const saleMonth = startMonth + monthOffset;
      distributeUnit(saleMonth, price_unit, targetArray);
    }
  }

  // distribuir vendas
  distributeUnits(p.pre_launch_sales || 0, 0, cfg.preLaunchMonths || 1, cfg.discountPre || 0, receiptsPre);
  distributeUnits(p.launch_sales || 0, cfg.preLaunchMonths || 0, cfg.launchMonths || 1, cfg.discountLaunch || 0, receiptsLaunch);

  let unitsAssigned = (p.pre_launch_sales || 0) + (p.launch_sales || 0);
  let monthIdx = (cfg.preLaunchMonths || 0) + (cfg.launchMonths || 0);
  while (unitsAssigned < p.units) {
    const unitsRemaining = p.units - unitsAssigned;
    const unitsThisMonth = Math.min(p.monthly_sales || 1, unitsRemaining);
    distributeUnits(unitsThisMonth, monthIdx, 1, 0, receiptsMonthly);
    unitsAssigned += unitsThisMonth;
    monthIdx++;
    if (monthIdx > 5000) break;
  }

  // comprimento necessário
  const projectedLen = Math.max(receiptsPre.length, receiptsLaunch.length, receiptsMonthly.length, p.months + restParc + 12);
  const maxLen = Math.max(projectedLen, p.months + 36);
  while (receiptsPre.length < maxLen) receiptsPre.push(0);
  while (receiptsLaunch.length < maxLen) receiptsLaunch.push(0);
  while (receiptsMonthly.length < maxLen) receiptsMonthly.push(0);

  // INVESTIMENTOS: curva "S" realista (15/25/35/25) ao longo de p.months
  const investments = new Array(maxLen).fill(0);
  const curve = [0.15, 0.25, 0.35, 0.25];
  if (p.months > 0) {
    const blocks = curve.length;
    // distribuir meses da obra proporcionalmente
    let remaining = p.months;
    let idx = 0;
    for (let bi = 0; bi < blocks; bi++){
      const pct = curve[bi];
      // meses do bloco: para preservar soma igual a p.months
      const monthsInBlock = bi < blocks - 1 ? Math.floor(p.months / blocks) : remaining;
      remaining -= monthsInBlock;
      if (monthsInBlock <= 0) continue;
      const monthlyValue = (totalConstruction * pct) / monthsInBlock;
      for (let m = 0; m < monthsInBlock; m++){
        if (idx < maxLen) investments[idx] = monthlyValue * Math.pow(1 + incc, idx); // indexa parcialmente pela inflação de obra
        idx++;
      }
    }
  }

  // custos operacionais e marketing
  const costs = new Array(maxLen).fill(0);
  const marketingTotal = 0.015 * VGV; // 1.5% do VGV
  const marketingStart = 0;
  const marketingEnd = Math.max( (cfg.preLaunchMonths || 0) + (cfg.launchMonths || 0), 1);
  const marketingDuration = Math.max(1, marketingEnd - marketingStart);
  const marketingMonthly = marketingTotal / marketingDuration;
  for (let m = marketingStart; m < marketingStart + marketingDuration && m < maxLen; m++) costs[m] += marketingMonthly;

  // custos fixos (admin/obras pequenas) — distribuídos durante obra
  for (let m = 0; m < Math.min(p.months, maxLen); m++){
    costs[m] += 8000 + 3000; // admin + supervisão
    if (m === 0) costs[m] += 0.05 * totalConstruction; // mobilização
    if (m % 12 === 0 && m < maxLen) costs[m] += 0.01 * VGV; // custo periódico
  }

  // contingência: provisiona percentualmente sobre custo de obra
  const contingencyTotal = contingencyPct * totalConstruction;
  // provisiona a contingência nos primeiros meses
  const contMonths = Math.min(6, p.months || 6);
  const contMonthly = contingencyTotal / Math.max(1, contMonths);
  for (let m = 0; m < contMonths && m < maxLen; m++) costs[m] += contMonthly;

  // cálculo de impostos e comissões por mês (sobre receitas do mês)
  const net = new Array(maxLen).fill(0);
  const commissions = new Array(maxLen).fill(0);
  const taxes = new Array(maxLen).fill(0);

  for (let m = 0; m < maxLen; m++){
    const entrada = (receiptsPre[m] || 0) + (receiptsLaunch[m] || 0) + (receiptsMonthly[m] || 0);
    commissions[m] = entrada * brokerPct; // comissões corretas por mês
    taxes[m] = entrada * taxesPct;       // impostos sobre receita
    const out = (investments[m] || 0) + (costs[m] || 0) + commissions[m] + taxes[m];
    net[m] = entrada - out;
  }

  // Metricas: IRR, NPV, Payback e ROI
  const irrMonthly = irr(net);
  const irrAnnual = isFinite(irrMonthly) ? Math.pow(1 + irrMonthly, 12) - 1 : NaN;
  const rate = Math.pow(1 + 0.12, 1 / 12) - 1; // taxa de desconto 12% a.a.
  const npvVal = net.reduce((s, v, i) => s + v / Math.pow(1 + rate, i), 0);

  // Payback mais robusto (interpolando dentro do mês)
  const cashIn = new Array(maxLen).fill(0);
  const cashOut = new Array(maxLen).fill(0);
  for (let m = 0; m < maxLen; m++){
    cashIn[m] = (receiptsPre[m] || 0) + (receiptsLaunch[m] || 0) + (receiptsMonthly[m] || 0);
    cashOut[m] = (investments[m] || 0) + (costs[m] || 0) + (commissions[m] || 0) + (taxes[m] || 0);
  }
  let cumul = 0;
  let payback = '--';
  for (let m = 0; m < maxLen; m++){
    const prev = cumul;
    const netM = (cashIn[m] || 0) - (cashOut[m] || 0);
    cumul += netM;
    if (cumul >= 0){
      if (prev < 0 && netM > 0){
        const frac = (0 - prev) / netM;
        // m é índice (0-based) -> converte para meses (1-based)
        payback = +(m + frac + 0).toFixed(2);
      } else {
        payback = m + 1;
      }
      break;
    }
  }

  const totalNet = net.reduce((s, v) => s + v, 0);
  const totalInvestment = investments.reduce((s, v) => s + v, 0) + contingencyTotal + (landPct * VGV);
  const roi = totalInvestment === 0 ? 0 : (totalNet / totalInvestment) * 100;

  const brokerTotal = brokerPct * VGV;

  return {
    receiptsPre,
    receiptsLaunch,
    receiptsMonthly,
    net,
    investments,
    costs,
    commissions,
    taxes,
    irrMonthly,
    irrAnnual,
    npvVal,
    payback,
    roi,
    VGV,
    totalConstruction,
    marketingTotal,
    brokerTotal
  };
}

// ---------- Renderização e gráficos (mantém layout e Chart.js) ----------
function renderSidebar(){
  const el = document.getElementById('projectsList'); if(!el) return;
  el.innerHTML = '';
  const searchVal = document.getElementById('search')?.value?.toLowerCase() || '';
  projects.forEach((p) => {
    if (searchVal && !p.name.toLowerCase().includes(searchVal)) return;
    const d = computeProject(p);
    const div = document.createElement('div'); div.className = 'project-card';
    const info = document.createElement('div'); info.className = 'info';
    info.innerHTML = `
      <label><strong>Nome</strong></label>
      <input type="text" value="${p.name.replace(/"/g,'&quot;')}" data-field="name">
      <label><strong>Cidade</strong></label>
      <input type="text" value="${p.city.replace(/"/g,'&quot;')}" data-field="city">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <div><label>Unidades</label><input type="number" value="${p.units}" data-field="units"></div>
        <div><label>Área (m²)</label><input type="number" value="${p.area}" data-field="area"></div>
        <div><label>Preço/m²</label><input type="number" value="${p.price_m2}" data-field="price_m2"></div>
        <div><label>Custo/m²</label><input type="number" value="${p.cost_m2}" data-field="cost_m2"></div>
        <div><label>Meses</label><input type="number" value="${p.months}" data-field="months"></div>
        <div><label>Pré-lançamento</label><input type="number" value="${p.pre_launch_sales}" data-field="pre_launch_sales"></div>
        <div><label>Lançamento</label><input type="number" value="${p.launch_sales}" data-field="launch_sales"></div>
        <div><label>Vendas/mês</label><input type="number" value="${p.monthly_sales}" data-field="monthly_sales"></div>
      </div>
      <div class="kpi">
        <div class="item"><div class="small">VGV</div><div class="value">${d.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
        <div class="item"><div class="small">ROI</div><div class="value">${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}</div></div>
        <div class="item"><div class="small">TIR</div><div class="value">${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}</div></div>
      </div>
    `;
    info.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('click', e => e.stopPropagation());
      const handleUpdate = () => {
        const field = inp.dataset.field;
        if (['units','area','price_m2','cost_m2','months','pre_launch_sales','launch_sales','monthly_sales'].includes(field)) {
          p[field] = Number(inp.value);
        } else {
          p[field] = inp.value;
        }
        renderSidebar();
        if (document.getElementById('detailModal')?.style.display === 'flex') openProjectModal(p.id);
      };
      inp.addEventListener('change', handleUpdate);
      inp.addEventListener('blur', handleUpdate);
    });
    div.appendChild(info);
    div.addEventListener('click', () => openProjectModal(p.id));
    el.appendChild(div);
  });
  updatePortfolioChart();
}

let portfolioChart = null;
function updatePortfolioChart(){
  const totals = projects.map(p => computeProject(p).VGV);
  const ctx = document.getElementById('chartPortfolio')?.getContext('2d');
  if(!ctx) return;
  if (portfolioChart) {
    portfolioChart.data.labels = projects.map(p => p.name);
    portfolioChart.data.datasets[0].data = totals;
    portfolioChart.update();
  } else {
    portfolioChart = new Chart(ctx, {
      type: 'doughnut',
      data: { labels: projects.map(p => p.name), datasets: [{ data: totals, backgroundColor: colors }] },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } } }
    });
  }
  document.getElementById('totalVgv').innerText = totals.reduce((s,v)=>s+v,0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
  // média de ROI e TIR (ignora NaN)
  const rois = projects.map(p=>computeProject(p).roi).filter(isFinite);
  const irrs = projects.map(p=>computeProject(p).irrAnnual).filter(isFinite);
  const avgRoi = rois.length ? rois.reduce((s,v)=>s+v,0)/rois.length : NaN;
  const avgIrr = irrs.length ? irrs.reduce((s,v)=>s+v,0)/irrs.length : NaN;
  document.getElementById('avgRoi').innerText = isFinite(avgRoi) ? avgRoi.toFixed(1)+'%' : '--';
  document.getElementById('avgIrr').innerText = isFinite(avgIrr) ? (avgIrr*100).toFixed(1)+'%' : '--';
}

// ---------- Modal e charts de detalhe (mantidos) ----------
let modalCharts = { fluxo: null, receitas: null, custos: null };
function destroyModalCharts(){
  Object.keys(modalCharts).forEach(k=>{ if (modalCharts[k]) { try{ modalCharts[k].destroy(); } catch(e){} modalCharts[k]=null; } });
}

function openProjectModal(id){
  const p = projects.find(x => x.id === id);
  if (!p) return;
  const d = computeProject(p);

  document.getElementById('modalTitle').innerText = p.name;
  document.getElementById('modalCity').innerText = p.city;
  document.getElementById('modalVgv').innerText = d.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});

  document.getElementById('modalStats').innerHTML = `
    <div class="stat"><div class="small">ROI</div><div style="font-weight:800;color:var(--gold)">${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}</div></div>
    <div class="stat"><div class="small">TIR (a.a.)</div><div style="font-weight:800;color:var(--gold)">${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}</div></div>
    <div class="stat"><div class="small">VPL (12% a.a.)</div><div style="font-weight:800;color:var(--gold)">${d.npvVal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Payback</div><div style="font-weight:800;color:var(--gold)">${d.payback} meses</div></div>
    <div class="stat"><div class="small">Custo construção</div><div style="font-weight:800;color:var(--gold)">${d.totalConstruction.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Marketing</div><div style="font-weight:800;color:var(--gold)">${d.marketingTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Comissão</div><div style="font-weight:800;color:var(--gold)">${d.brokerTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Unidades</div><div style="font-weight:800;color:var(--gold)">${p.units}</div></div>
    <div class="stat"><div class="small">Área total</div><div style="font-weight:800;color:var(--gold)">${(p.units * p.area).toLocaleString('pt-BR')} m²</div></div>
    <div class="stat"><div class="small">Receita média/unidade</div><div style="font-weight:800;color:var(--gold)">${(d.VGV / p.units).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Lucro estimado</div><div style="font-weight:800;color:var(--gold)">${(d.VGV - d.totalConstruction - d.marketingTotal - d.brokerTotal).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
  `;

  document.getElementById('detailModal').style.display = 'flex';
  destroyModalCharts();

  function createModalChart(ctx, datasets){
    return new Chart(ctx, {
      type: 'line',
      data: { labels: Array.from({length: d.net.length}, (_, i) => 'M' + (i+1)), datasets: datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode:'nearest', axis:'x', intersect:false },
        scales: { x: { ticks: { color:'#fff' } }, y: { ticks: { color:'#fff' } } },
        plugins: {
          legend: { labels: { color:'#fff' } },
          tooltip: {
            callbacks: {
              label: function(context){
                const v = context.raw || 0;
                const total = context.dataset.data.slice(0, context.dataIndex+1).reduce((s,x)=>s+x,0);
                return context.dataset.label + ': ' + v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}) + ' (Total: ' + total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}) + ')';
              }
            }
          }
        }
      }
    });
  }

  modalCharts.fluxo = createModalChart(document.getElementById('chartFluxo').getContext('2d'), [
    { label: 'Fluxo Líquido', data: d.net, borderColor: '#c9a84b', backgroundColor: 'rgba(201,168,75,0.08)', fill: true, tension: 0.3 }
  ]);
  modalCharts.receitas = createModalChart(document.getElementById('chartReceitas').getContext('2d'), [
    { label: 'Pré-lançamento', data: d.receiptsPre, borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.12)', fill: true, tension: 0.3 },
    { label: 'Lançamento', data: d.receiptsLaunch, borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.08)', fill: true, tension: 0.3 },
    { label: 'Mensais', data: d.receiptsMonthly, borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.06)', fill: true, tension: 0.3 }
  ]);
  const combinedCosts = d.investments.map((v,i)=>(v||0)+(d.costs[i]||0));
  modalCharts.custos = createModalChart(document.getElementById('chartCustos').getContext('2d'), [
    { label: 'Investimentos', data: d.investments, borderColor: '#9c27b0', backgroundColor: 'rgba(156,39,176,0.06)', fill: true, tension: 0.3 },
    { label: 'Custos operacionais', data: d.costs, borderColor: '#f44336', backgroundColor: 'rgba(244,67,54,0.06)', fill: true, tension: 0.3 },
    { label: 'Total Custos', data: combinedCosts, borderColor: '#ff5722', backgroundColor: 'rgba(255,87,34,0.06)', fill: true, tension: 0.3 }
  ]);
  setActiveTab('fluxo');
}

// ---------- Eventos e persistência (mantém comportamento) ----------
document.getElementById('closeModal')?.addEventListener('click', ()=>{ document.getElementById('detailModal').style.display = 'none'; destroyModalCharts(); });

document.querySelectorAll('#modalTabs .tab-btn').forEach(btn=>{ btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)); });
function setActiveTab(tab){
  document.querySelectorAll('#modalTabs .tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
  document.getElementById('wrapFluxo').style.display = (tab==='fluxo') ? 'block' : 'none';
  document.getElementById('wrapReceitas').style.display = (tab==='receitas') ? 'block' : 'none';
  document.getElementById('wrapCustos').style.display = (tab==='custos') ? 'block' : 'none';
  Object.keys(modalCharts).forEach(k=>{ if(modalCharts[k]) try{ modalCharts[k].resize(); modalCharts[k].update(); } catch(e){} });
}

function saveAll(){ localStorage.setItem('aps_projects', JSON.stringify(projects)); saveCfg(); alert('Alterações salvas no navegador (localStorage).'); }
function exportJson(){ const blob = new Blob([JSON.stringify(projects, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'aps_projects.json'; a.click(); URL.revokeObjectURL(url); }
function downloadCsv(){ const rows = ['id,name,city,units,area,price_m2,cost_m2,months,pre_launch_sales,launch_sales,monthly_sales']; projects.forEach(p => rows.push([p.id,p.name,p.city,p.units,p.area,p.price_m2,p.cost_m2,p.months,p.pre_launch_sales,p.launch_sales,p.monthly_sales].join(','))); const blob = new Blob([rows.join('\n')], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'aps_projects.csv'; a.click(); URL.revokeObjectURL(url); }

document.getElementById('btnLogin')?.addEventListener('click', () => {
  const input = document.getElementById('pwd');
  const box = document.getElementById('loginBox');
  if (input.value === PASSWORD) {
    document.getElementById('loginModal').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    const saved = localStorage.getItem('aps_projects');
    if (saved) try { projects = JSON.parse(saved); } catch(e){}
    loadCfg();
    renderSidebar();
  } else {
    if(box){ box.style.transform = 'translateX(-10px)'; box.style.borderColor = '#f44336'; box.style.boxShadow = '0 0 15px rgba(244,67,54,0.6)'; setTimeout(() => { box.style.transform = 'translateX(10px)'; }, 100); setTimeout(() => { box.style.transform = 'translateX(-10px)'; }, 200); setTimeout(() => { box.style.transform = 'translateX(0)'; box.style.borderColor = 'rgba(255,255,255,0.05)'; box.style.boxShadow='0 0 15px rgba(201,168,75,0.4)'; }, 300); }
    input.value = '';
    input.focus();
  }
});

document.getElementById('pwd')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') document.getElementById('btnLogin').click(); });

document.getElementById('btnExport')?.addEventListener('click', exportJson);
document.getElementById('btnPublish')?.addEventListener('click', saveAll);
document.getElementById('btnReset')?.addEventListener('click', ()=>{ if(confirm('Restaurar valores iniciais?')){ localStorage.removeItem('aps_projects'); localStorage.removeItem(cfgKey); location.reload(); } });

document.getElementById('btnNew')?.addEventListener('click', ()=>{ const id = projects.length + 1; projects.push({ id:id, name:'Novo Empreendimento '+id, city:'Cidade', units:10, area:70, price_m2:5000, cost_m2:2000, months:18, pre_launch_sales:0, launch_sales:0, monthly_sales:2 }); renderSidebar(); });
document.getElementById('btnDownloadCsv')?.addEventListener('click', downloadCsv);

// salvar cfg ao alterar inputs (mantém ids originais)
['discountPre','discountLaunch','parcelasRestantes','entradaPct','entradaMonths','preLaunchMonths','launchMonths','incc','ipca','payAtoPct','payInterPct','payInterMonth','payChavesPct'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener('change', saveCfg);
});

window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('aps_projects');
  if(saved) try { projects = JSON.parse(saved); } catch(e){}
  loadCfg();
});

</script>

</body>
</html>
