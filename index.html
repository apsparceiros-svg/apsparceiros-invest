<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#070707;--panel:#0f0f0f;--muted:#9e9e9e;--gold:#c9a84b;--card:#121212;--accent:#e6e6e6}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:20px 28px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:20px;padding:20px}
.sidebar{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:18px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:center;border:1px solid rgba(255,255,255,0.03)}
.project-card .info{flex:1}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:100px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],.controls input[type=number],.controls select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.row{display:flex;gap:12px}
.col{flex:1}
.footer{margin-top:16px;color:var(--muted);font-size:13px;text-align:center}

.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:14px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}

.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:220px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:8px;position:absolute;z-index:10;bottom:125%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}

/* responsive */
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio de Investimentos · Protegido</div>
</header>

<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por status / valor</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label class="small">Mostrar indicadores</label>
        <select id="showIndicators"><option value="all">Todos</option><option value="vgv">VGV</option><option value="irr">TIR</option></select>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer">APSPARCEIROS Invest · Template editável · Protected</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Painel interativo — edite valores e atualize para recalcular</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tooltip"><button id="btnHelp" class="button ghost">Legenda</button><div class="tt"><strong>ROI</strong>: retorno sobre investimento. <br><strong>TIR</strong>: taxa interna de retorno anualizada.</div></div>
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 420px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <canvas id="chartPortfolio" height="120"></canvas>
            </div>
            <div style="width:220px">
              <div class="kpi"><div class="item"><div class="small">ROI médio</div><div class="value" id="avgRoi">--</div></div><div class="item"><div class="small">TIR média</div><div class="value" id="avgIrr">--</div></div></div>
              <div style="margin-top:10px" class="small">Clique num projeto no menu lateral para ver detalhes.</div>
            </div>
          </div>
        </div>

        <div id="detailArea"></div>

      </section>

      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table style="width:100%">
            <thead><tr><th class="small">Indicador</th><th class="small">Definição</th></tr></thead>
            <tbody>
              <tr><td>VGV</td><td class="small">Valor Geral de Vendas</td></tr>
              <tr><td>ROI</td><td class="small">Retorno sobre o capital</td></tr>
              <tr><td>TIR</td><td class="small">Taxa interna de retorno</td></tr>
              <tr><td>Payback</td><td class="small">Meses para recuperar investimento</td></tr>
            </tbody>
          </table>
        </div>

        <div class="card">
          <div class="section-title">Cap Table (exemplo)</div>
          <div class="small">Incorporador: 50%<br>Terrenista: 20%<br>Investidores: 30%</div>
        </div>

      </aside>
    </div>
  </main>
</div>

<script>
// initial projects data
let projects = [
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,sales_per_month:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,sales_per_month:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,sales_per_month:4}
];

const password = "Investidor";

// basic IRR implementation (monthly series)
function irr(values, guess=0.01){
  const eps=1e-7, maxIter=1000;
  let rate=guess;
  const npv = r => values.reduce((s,v,i)=>s + v / Math.pow(1+r,i),0);
  const dnpv = r => values.reduce((s,v,i)=>s - i * v / Math.pow(1+r,i+1),0);
  for(let i=0;i<maxIter;i++){
    const f=npv(rate), df=dnpv(rate);
    if(Math.abs(df) < 1e-12) break;
    const nr = rate - f/df;
    if(Math.abs(nr-rate) < eps) return rate;
    rate = nr;
  }
  // fallback binary search
  let low=-0.999, high=10;
  for(let i=0;i<200;i++){
    const mid=(low+high)/2; const v=npv(mid);
    if(Math.abs(v) < 1e-6) return mid;
    if(v>0) low=mid; else high=mid;
  }
  return rate;
}

// compute flows and metrics
function computeProject(p){
  const months = p.months;
  const price_unit = p.area * p.price_m2;
  const VGV = p.units * price_unit;
  // receipts distribution: 10% sinal, 10% parcelado until delivery, 80% at delivery
  const salesMonths = Math.ceil(p.units / p.sales_per_month);
  const receipts = Array(months).fill(0);
  const investments = Array(months).fill(0);
  const costs = Array(months).fill(0);

  // construction curve linear weighted and INCC 0.45% monthly
  const incc = 0.0045;
  const den = (months*(months+1))/2;
  const totalConstruction = p.units * p.area * p.cost_m2;
  for(let m=1;m<=months;m++){
    const prop = m/den;
    const base = totalConstruction * prop;
    const invested = base * Math.pow(1+incc,m);
    investments[m-1] = invested;
  }

  // sales schedule receipts & commissions
  let sold=0;
  for(let s=1;s<=salesMonths;s++){
    const unitsThis = Math.min(p.sales_per_month, p.units - sold);
    sold += unitsThis;
    for(let u=0;u<unitsThis;u++){
      const sinal = 0.10 * price_unit;
      const parcelTotal = 0.10 * price_unit;
      const parcelMonths = Math.max(1, months - s);
      const parcel = parcelTotal / parcelMonths;
      receipts[s-1] += sinal;
      for(let mm=s; mm<months; mm++) receipts[mm] += parcel;
      receipts[months-1] += 0.80 * price_unit;
    }
  }

  // costs: marketing 1.5% VGV first 12 months, brokers 5% VGV allocated on sale months, taxes 1% at month 12, admin/legal monthly
  const VGV_total = VGV;
  const marketingTotal = 0.015 * VGV_total;
  const marketingMonthly = marketingTotal / 12;
  const brokerTotal = 0.05 * VGV_total;
  const brokerPerUnit = brokerTotal / p.units;
  let sold2=0; let saleSchedule=[];
  for(let s=1;s<=salesMonths;s++){ const unitsThis = Math.min(p.sales_per_month, p.units - sold2); sold2 += unitsThis; saleSchedule.push({month:s,units:unitsThis}); }
  for(const ss of saleSchedule){ costs[ss.month-1] += ss.units * brokerPerUnit; }
  for(let m=1;m<=months;m++){
    if(m<=12) costs[m-1] += marketingMonthly;
    if(m===12) costs[m-1] += 0.01 * VGV_total;
    costs[m-1] += 8000 + 3000; // admin + legal
    if(m===1) costs[m-1] += 0.05 * totalConstruction; // contingency 5% at start
  }

  // net flow
  const net = receipts.map((r,i)=> r - investments[i] - costs[i]);
  // metrics
  const irrMonthly = irr(net);
  const irrAnnual = Math.pow(1+irrMonthly,12)-1;
  const npvVal = (function(){
    const rate = Math.pow(1+0.12,1/12)-1;
    return net.reduce((s,v,i)=> s + v / Math.pow(1+rate,i),0);
  })();
  let cumul=0,payback='--';
  for(let i=0;i<net.length;i++){ cumul += net[i]; if(cumul>=0){ payback = i+1; break; } }
  const totalNet = net.reduce((s,v)=>s+v,0);
  const roi = (totalNet / (investments.reduce((s,v)=>s+v,0))) * 100;

  return {receipts,investments,costs,net,irrMonthly,irrAnnual,npvVal,payback,roi,VGV_total,totalConstruction,marketingTotal,brokerTotal};
}

// rendering sidebar projects
function renderSidebar(){
  const el = document.getElementById('projectsList'); el.innerHTML='';
  projects.forEach(p=>{
    const metrics = computeProject(p);
    const div = document.createElement('div'); div.className='project-card';
    const info = document.createElement('div'); info.className='info';
    info.innerHTML = `<strong>${p.name}</strong><div class="small">${p.city}</div>
      <div class="kpi">
        <div class="item"><div class="small">VGV</div><div class="value">${metrics.VGV_total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
        <div class="item"><div class="small">ROI</div><div class="value">${metrics.roi.toFixed(1)}%</div></div>
        <div class="item"><div class="small">TIR</div><div class="value">${(metrics.irrAnnual*100).toFixed(1)}%</div></div>
      </div>`;
    const chartCanvas = document.createElement('canvas'); chartCanvas.width=100; chartCanvas.height=40;
    div.appendChild(info); div.appendChild(chartCanvas);
    div.addEventListener('click',()=> selectProject(p.id));
    // tooltip with explanation
    const tip = document.createElement('div'); tip.className='small tooltip'; tip.style.marginTop='8px'; tip.innerHTML='Sobre • <span class="tt">Passe o mouse para ver</span>';
    info.appendChild(tip);
    el.appendChild(div);
    // mini chart
    const ctx = chartCanvas.getContext('2d');
    new Chart(ctx,{type:'line',data:{labels:metrics.net.map((_,i)=>i+1),datasets:[{data:metrics.net,fill:true,borderColor:'#c9a84b',backgroundColor:'rgba(201,168,75,0.08)',tension:0.3,pointRadius:0}]},options:{responsive:false,plugins:{legend:{display:false},tooltip:{enabled:false}},scales:{x:{display:false},y:{display:false}}}});
  });
  // update portfolio chart
  updatePortfolioChart();
}

let portfolioChart=null;
function updatePortfolioChart(){
  const totals = projects.map(p=> computeProject(p).VGV_total);
  const ctx = document.getElementById('chartPortfolio').getContext('2d');
  if(portfolioChart) portfolioChart.destroy();
  portfolioChart = new Chart(ctx,{type:'doughnut',data:{labels:projects.map(p=>p.name),datasets:[{data:totals,backgroundColor:['#c9a84b','#b58f3a','#d9b86b']}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#fff'}}}}});
  document.getElementById('totalVgv').innerText = totals.reduce((s,v)=>s+v,0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
  // avg KPIs
  const avgRoi = (projects.reduce((s,p)=> s + computeProject(p).roi,0) / projects.length);
  const avgIrr = (projects.reduce((s,p)=> s + computeProject(p).irrAnnual,0) / projects.length);
  document.getElementById('avgRoi').innerText = isFinite(avgRoi)? avgRoi.toFixed(1)+'%':'--';
  document.getElementById('avgIrr').innerText = isFinite(avgIrr)? (avgIrr*100).toFixed(1)+'%':'--';
}

// select project and render details
function selectProject(id){
  const p = projects.find(x=>x.id===id);
  const d = computeProject(p);
  const area = document.getElementById('detailArea');
  area.innerHTML = `
    <div class="card">
      <div style="display:flex;justify-content:space-between">
        <div><strong>${p.name}</strong><div class="small">${p.city}</div></div>
        <div style="text-align:right"><div class="small">VGV</div><div style="font-weight:800;color:var(--gold)">${d.VGV_total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
      </div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div style="flex:1"><canvas id="chartCash${id}" height="140"></canvas></div>
        <div style="width:320px"><div class="card"><div class="small">Resumo</div><div style="margin-top:8px"><strong>ROI:</strong> ${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}<br><strong>TIR (a.a.):</strong> ${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}<br><strong>VPL (12% a.a.):</strong> ${d.npvVal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}<br><strong>Payback:</strong> ${d.payback} meses</div></div>
        <div class="card" style="margin-top:12px"><div class="small">Custos</div><div style="margin-top:8px">Custo construção: ${d.totalConstruction.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}<br>Marketing: ${d.marketingTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}<br>Comissão: ${d.brokerTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div></div>
      </div>

      <div style="margin-top:12px" class="small">Legenda: Passe o mouse sobre os pontos do gráfico para ver os valores mensais.</div>
    </div>
  `;
  // draw cashflow chart
  const ctx = document.getElementById('chartCash'+id).getContext('2d');
  new Chart(ctx,{type:'line',data:{labels:d.net.map((_,i)=>i+1),datasets:[{label:'Fluxo Líquido',data:d.net,borderColor:'#c9a84b',backgroundColor:'rgba(201,168,75,0.08)',fill:true,tension:0.3}]},options:{plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>{return 'R$ '+Number(ctx.raw).toLocaleString('pt-BR');}}}},scales:{y:{ticks:{callback:v=> 'R$ '+Number(v).toLocaleString('pt-BR')}}}});
}

// persist to localStorage and export
function saveAll(){
  localStorage.setItem('aps_projects', JSON.stringify(projects));
  alert('Alterações salvas (localStorage). Para publicar, faça commit no repositório.');
}
function exportJson(){
  const blob = new Blob([JSON.stringify(projects,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='aps_projects.json'; a.click(); URL.revokeObjectURL(url);
}

document.getElementById('btnLogin').addEventListener('click', ()=>{
  const v = document.getElementById('pwd').value;
  if(v === PASSWORD){ document.getElementById('loginModal').style.display='none'; document.getElementById('app').style.display='flex'; renderSidebar(); } else { alert('Senha incorreta'); }
});

document.getElementById('btnExport').addEventListener('click', exportJson);
document.getElementById('btnPublish').addEventListener('click', saveAll);
document.getElementById('btnReset').addEventListener('click', ()=>{ if(confirm('Restaurar valores iniciais?')){ localStorage.removeItem('aps_projects'); location.reload(); }});
document.getElementById('btnNew').addEventListener('click', ()=>{ const id=projects.length+1; projects.push({id,name:'Novo Empreendimento '+id,city:'Cidade',units:10,area:70,price_m2:5000,cost_m2:2000,months:18,sales_per_month:2}); renderSidebar(); });

// load from localStorage if exists
const saved = localStorage.getItem('aps_projects'); if(saved){ try{ projects = JSON.parse(saved); }catch(e){ } }
window.addEventListener('load', ()=>{ renderSidebar(); document.getElementById('app').style.display='flex'; document.getElementById('loginModal').style.display='none'; updatePortfolioChart(); });

</script>
</body>
</html>
