<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APSPARCEIROS Invest — Dashboard Avançado</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#070707;--panel:#0f0f0f;--muted:#9e9e9e;--gold:#c9a84b;--card:#121212;--accent:#e6e6e6;}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column;transition:0.2s}
.project-card:hover{background:rgba(201,168,75,0.1)}
.project-card .info{flex:1;width:100%}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text], .controls input[type=number], .project-card input[type=text], .project-card input[type=number]{
    background-color: #1e1e1e; color: #fff; border: 1px solid #c9a84b; padding: 6px 8px; border-radius: 6px; width: 100%; margin-bottom:6px;
}
.project-card input[type=text]:focus, .project-card input[type=number]:focus{outline:2px solid #c9a84b;background-color:#292929;}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
table{width:100%;border-collapse:collapse;margin-top:6px}
table, th, td{border:1px solid rgba(255,255,255,0.05);}
th, td{padding:6px;font-size:12px;color:var(--accent);text-align:right}
th{background:rgba(255,255,255,0.03);color:var(--gold)}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio Avançado</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para acessar o dashboard</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Projetos</div>
    <div id="projectsList"></div>
    <div class="card">
      <div class="controls">
        <label>Busca</label>
        <input id="search" type="text" placeholder="Pesquisar projeto...">
        <label>Cidade</label>
        <input id="filterCity" type="text" placeholder="Filtrar por cidade...">
        <label>Porcentagem de entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">
        <label>Parcelas da entrada</label>
        <input id="entradaParc" type="number" min="1" step="1" value="6">
        <label>Parcelas restantes saldo</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">
        <div style="display:flex;gap:6px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnDownloadCsv" class="button ghost">Exportar CSV</button>
        </div>
      </div>
    </div>
    <button id="btnNew" class="button" style="width:100%;margin-top:10px">+ Novo Projeto</button>
  </aside>

  <main class="content">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div><h2 id="panelTitle">Dashboard Avançado</h2><div class="small">Comparativo de projetos e fluxos financeiros</div></div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tooltip"><button class="button ghost">Legenda</button>
          <div class="tt">
            <strong>ROI</strong>: Retorno sobre capital investido<br>
            <strong>TIR</strong>: Taxa interna de retorno anualizada<br>
            <strong>Payback</strong>: Meses para recuperar investimento
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <canvas id="chartAll" height="180"></canvas>
    </div>

    <div id="detailArea"></div>
  </main>
</div>

<script>
// ===== Dados iniciais =====
let projects = JSON.parse(localStorage.getItem('aps_projects')) || [
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,pre_launch_sales:2,launch_sales:4,monthly_sales:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,pre_launch_sales:1,launch_sales:3,monthly_sales:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,pre_launch_sales:3,launch_sales:5,monthly_sales:4}
];
const PASSWORD="Investidor";
let saleCfg = JSON.parse(localStorage.getItem('aps_sale_cfg')) || { entradaPct:30, entradaParc:6, parcelasRestantes:24 };
const colors=['#c9a84b','#b58f3a','#d9b86b','#d9b86b','#8bc34a','#2196f3','#9c27b0'];

// ===== Persistência =====
function saveProjects(){ localStorage.setItem('aps_projects',JSON.stringify(projects)); renderSidebar(); renderCharts(); if(selectedProject!==null) selectProject(selectedProject);}
function saveCfg(){ saleCfg.entradaPct=Number(document.getElementById('entradaPct').value)||30; saleCfg.entradaParc=Math.max(1,Math.floor(Number(document.getElementById('entradaParc').value)||6)); saleCfg.parcelasRestantes=Math.max(1,Math.floor(Number(document.getElementById('parcelasRestantes').value)||24)); localStorage.setItem('aps_sale_cfg',JSON.stringify(saleCfg)); renderSidebar(); renderCharts();}

// ===== Funções financeiras =====
function irr(values, guess=0.01){ const eps=1e-7; const maxIter=1000; let rate=guess; const npv=r=>values.reduce((s,v,i)=>s+v/Math.pow(1+r,i),0); const dnpv=r=>values.reduce((s,v,i)=>s-i*v/Math.pow(1+r,i+1),0); for(let i=0;i<maxIter;i++){ const f=npv(rate),df=dnpv(rate); if(Math.abs(df)<1e-12) break; const nr=rate-f/df; if(Math.abs(nr-rate)<eps) return rate; rate=nr;} return rate;}
function computeProject(p){const cfg=saleCfg; const months=p.months; const price_unit_full=p.area*p.price_m2; const VGV=p.units*price_unit_full; const totalConstruction=p.units*p.area*p.cost_m2; const receipts=[]; function ensureLen(arr,len){while(arr.length<len)arr.push(0);} function addSalePayments(saleMonth,price_unit,targetArray){const entradaTotal=price_unit*(cfg.entradaPct/100); const entradaParcel=entradaTotal/cfg.entradaParc; const restanteTotal=price_unit-entradaTotal; for(let m=0;m<cfg.entradaParc;m++){const idx=saleMonth+m; ensureLen(targetArray,idx+1); targetArray[idx]+=entradaParcel;} for(let m=0;m<cfg.parcelasRestantes;m++){const idx=saleMonth+cfg.entradaParc+m; ensureLen(targetArray,idx+1); targetArray[idx]+=restanteTotal/cfg.parcelasRestantes;}} function distributeUnits(units,startMonth,targetArray){for(let u=0;u<units;u++){addSalePayments(startMonth+u,price_unit_full,targetArray);}} distributeUnits(p.pre_launch_sales,0,receipts); distributeUnits(p.launch_sales,p.pre_launch_sales,receipts); let unitsSoldMonthly=0; let monthIdx=p.pre_launch_sales+p.launch_sales; while(unitsSoldMonthly<p.units-(p.pre_launch_sales+p.launch_sales)){const unitsThisMonth=Math.min(p.monthly_sales,p.units-(p.pre_launch_sales+p.launch_sales)-unitsSoldMonthly); distributeUnits(unitsThisMonth,monthIdx,receipts); unitsSoldMonthly+=unitsThisMonth; monthIdx++;} const flow=[],cumFlow=[]; let cum=0; const totalMonths=Math.max(receipts.length,months); for(let i=0;i<totalMonths;i++){const r=receipts[i]||0; const c=totalConstruction/totalMonths; const net=r-c; flow.push({month:i+1,receita:r,invest:c,net}); cum+=net; cumFlow.push(cum);} const roi=cum/totalConstruction; const cashflows=[-totalConstruction,...flow.map(f=>f.receita)]; const tir=irr(cashflows)*100; let payback=flow.findIndex(f=>cumFlow[f.month-1]>=0)+1; if(payback<0) payback='>'+months; return {flow,cumFlow,VGV,totalConstruction,roi,tir,payback};}

// ===== Renderização =====
let selectedProject=null;
function renderSidebar(){
  const list=document.getElementById('projectsList');
  list.innerHTML='';
  const search=document.getElementById('search').value.toLowerCase();
  const city=document.getElementById('filterCity').value.toLowerCase();
  projects.forEach((p,i)=>{
    if(search && !p.name.toLowerCase().includes(search)) return;
    if(city && !p.city.toLowerCase().includes(city)) return;
    const card=document.createElement('div');
    card.className='project-card';
    const infoDiv=document.createElement('div');
    infoDiv.className='info';
    infoDiv.innerHTML=`<strong>Projeto #${p.id}</strong>`;
    
    // Inputs para edição inline
    ['name','city','units','area','price_m2','cost_m2','months','pre_launch_sales','launch_sales','monthly_sales'].forEach(key=>{
      const label=document.createElement('label');
      label.className='small';
      label.textContent=key.replace(/_/g,' ').toUpperCase();
      const input=document.createElement('input');
      input.type=(typeof p[key]==='number')?'number':'text';
      input.value=p[key];
      input.onchange=e=>{projects[i][key]=input.type==='number'?Number(input.value):input.value; saveProjects();}
      card.appendChild(label);
      card.appendChild(input);
    });
    
    list.appendChild(card);
  });
}

let chartAll=null;
function renderCharts(){
  const ctx=document.getElementById('chartAll').getContext('2d');
  const maxMonths=Math.max(...projects.map(p=>computeProject(p).flow.length));
  const labels=Array.from({length:maxMonths},(_,i)=>i+1);
  const datasets=projects.map((p,i)=>{
    const c=computeProject(p);
    return {label:p.name,data:c.cumFlow,borderColor:colors[i%colors.length],backgroundColor:colors[i%colors.length]+'33',tension:0.3};
  });
  if(chartAll) chartAll.destroy();
  chartAll=new Chart(ctx,{type:'line',data:{labels,datasets},options:{responsive:true,plugins:{legend:{position:'bottom'}},scales:{y:{beginAtZero:true,title:{display:true,text:'Fluxo Acumulado (R$)'}},x:{title:{display:true,text:'Mês'}}}}});
}

function selectProject(i){
  selectedProject=i;
  const p=projects[i]; const comp=computeProject(p);
  const dArea=document.getElementById('detailArea');
  dArea.innerHTML=`<div class="card">
    <strong>${p.name} — ${p.city}</strong>
    <table>
      <thead><tr><th>Mês</th><th>Receita</th><th>Investimento</th><th>Fluxo Líquido</th><th>Acumulado</th></tr></thead>
      <tbody>${comp.flow.map(f=>`<tr><td>${f.month}</td><td>R$ ${f.receita.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>R$ ${f.invest.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>R$ ${f.net.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td><td>R$ ${comp.cumFlow[f.month-1].toLocaleString('pt-BR',{minimumFractionDigits:2})}</td></tr>`).join('')}</tbody>
    </table>
    <div class="kpi" style="margin-top:6px">
      <div class="item"><div class="small">ROI</div><div class="value">${(comp.roi*100).toFixed(1)}%</div></div>
      <div class="item"><div class="small">TIR</div><div class="value">${comp.tir.toFixed(1)}%</div></div>
      <div class="item"><div class="small">Payback</div><div class="value">${comp.payback} meses</div></div>
      <div class="item"><div class="small">VGV</div><div class="value">R$ ${comp.VGV.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div>
      <div class="item"><div class="small">Investimento</div><div class="value">R$ ${comp.totalConstruction.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div>
    </div>
  </div>`;
}

// ===== Eventos =====
document.getElementById('btnLogin').onclick=()=>{
  const pwd=document.getElementById('pwd').value;
  if(pwd===PASSWORD){document.getElementById('loginModal').style.display='none';document.getElementById('app').style.display='flex';renderSidebar();renderCharts();}
  else alert('Senha incorreta');
}

document.getElementById('entradaPct').onchange=document.getElementById('entradaParc').onchange=document.getElementById('parcelasRestantes').onchange=saveCfg;
document.getElementById('search').oninput=renderSidebar;
document.getElementById('filterCity').oninput=renderSidebar;

document.getElementById('btnExport').onclick=()=>{
  const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(projects,null,2)); a.download='projects.json'; a.click();
}
document.getElementById('btnDownloadCsv').onclick=()=>{
  let csv='Projeto,Cidade,Mês,Receita,Investimento,Fluxo Líquido,Acumulado\n';
  projects.forEach(p=>{const c=computeProject(p); c.flow.forEach(f=>{csv+=`${p.name},${p.city},${f.month},${f.receita.toFixed(2)},${f.invest.toFixed(2)},${f.net.toFixed(2)},${c.cumFlow[f.month-1].toFixed(2)}\n`});});
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv); a.download='projects.csv'; a.click();
}
document.getElementById('btnNew').onclick=()=>{
  const id=projects.length?Math.max(...projects.map(p=>p.id))+1:1;
  const n='Novo Projeto '+id;
  projects.push({id,name:n,city:'Cidade',units:10,area:70,price_m2:6000,cost_m2:2500,months:24,pre_launch_sales:0,launch_sales:0,monthly_sales:1});
  saveProjects();
}

</script>

</body>
</html>
