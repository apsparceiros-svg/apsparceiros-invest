<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f0f;
  --muted:#9e9e9e;
  --gold:#c9a84b;
  --card:#121212;
  --accent:#e6e6e6;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column}
.project-card .info{flex:1;width:100%}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color: #1e1e1e;
    color: #fff;
    border: 1px solid #c9a84b;
    padding: 6px 8px;
    border-radius: 6px;
    width: 100%;
    margin-bottom:6px;
}
.project-card input[type=text]:focus,
.project-card input[type=number]:focus{
    outline:2px solid #c9a84b;
    background-color:#292929;
}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
table{width:100%;border-collapse:collapse}
table th, table td{border:1px solid rgba(255,255,255,0.1);padding:6px;text-align:right;font-size:12px;color:var(--accent)}
table th{text-align:center;background:rgba(255,255,255,0.05)}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por indicador</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label class="small">Mostrar</label>
        <select id="showIndicators"><option value="all">Todos</option><option value="vgv">VGV</option><option value="irr">TIR</option></select>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0">

        <div><strong>Condições de Venda</strong></div>
        <label>Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">
        <label>Nº de parcelas da entrada</label>
        <input id="entradaParc" type="number" min="1" step="1" value="6">
        <label>Parcelas restantes do imóvel</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnPublish" class="button">Salvar alterações</button>
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <canvas id="chartPortfolio" height="140" style="margin-top:12px"></canvas>
        </div>

        <div id="detailArea"></div>
      </section>

      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table>
            <tbody>
              <tr><td class="small">VGV</td><td class="small">Valor Geral de Vendas</td></tr>
              <tr><td class="small">ROI</td><td class="small">Retorno sobre o capital</td></tr>
              <tr><td class="small">TIR</td><td class="small">Taxa interna de retorno</td></tr>
              <tr><td class="small">Payback</td><td class="small">Meses para recuperar investimento</td></tr>
              <tr><td class="small">VLP</td><td class="small">Valor líquido presente</td></tr>
            </tbody>
          </table>
        </div>
      </aside>
    </div>
  </main>
</div>

<script>
// ===== Configuração e dados iniciais =====
const PASSWORD="Investidor";
const colors=['#c9a84b','#b58f3a','#d9b86b','#8bc34a','#2196f3','#9c27b0'];
let projects=[
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,pre_launch_sales:2,launch_sales:4,monthly_sales:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,pre_launch_sales:1,launch_sales:3,monthly_sales:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,pre_launch_sales:3,launch_sales:5,monthly_sales:4}
];

let saleCfg={entradaPct:30,entradaParc:6,parcelasRestantes:24};
function loadCfg(){ 
  const s=localStorage.getItem('aps_sale_cfg'); 
  if(s) try{saleCfg=Object.assign(saleCfg,JSON.parse(s));}catch(e){}
  document.getElementById('entradaPct').value=saleCfg.entradaPct;
  document.getElementById('entradaParc').value=saleCfg.entradaParc;
  document.getElementById('parcelasRestantes').value=saleCfg.parcelasRestantes;
}
function saveCfg(){ 
  saleCfg.entradaPct=Number(document.getElementById('entradaPct').value)||30;
  saleCfg.entradaParc=Math.max(1,Math.floor(Number(document.getElementById('entradaParc').value)||6));
  saleCfg.parcelasRestantes=Math.max(1,Math.floor(Number(document.getElementById('parcelasRestantes').value)||24));
  localStorage.setItem('aps_sale_cfg',JSON.stringify(saleCfg));
}

// ===== Funções financeiras =====
function irr(values, guess=0.01){const eps=1e-7,maxIter=1000;let rate=guess;const npv=r=>values.reduce((s,v,i)=>s+v/Math.pow(1+r,i),0);const dnpv=r=>values.reduce((s,v,i)=>s-i*v/Math.pow(1+r,i+1),0);for(let i=0;i<maxIter;i++){const f=npv(rate),df=dnpv(rate);if(Math.abs(df)<1e-12) break;const nr=rate-f/df;if(Math.abs(nr-rate)<eps) return rate;rate=nr;}let low=-0.999,high=10;for(let i=0;i<200;i++){const mid=(low+high)/2,v=npv(mid);if(Math.abs(v)<1e-6) return mid;if(v>0) low=mid;else high=mid;}return rate;}

// ===== Cálculo de fluxo =====
function computeProject(p){
  const cfg=saleCfg;
  const price_unit=p.area*p.price_m2;
  const VGV=p.units*price_unit;
  const totalConstruction=p.units*p.area*p.cost_m2;
  const receiptsPre=[],receiptsLaunch=[],receiptsMonthly=[];
  function ensureLen(arr,len){while(arr.length<len) arr.push(0);}
  function addSalePayments(saleMonth,price_unit,targetArray){
    const entradaTotal=price_unit*cfg.entradaPct/100;
    const entradaParcel=entradaTotal/cfg.entradaParc;
    const restanteTotal=price_unit-entradaTotal;
    const restParc=cfg.parcelasRestantes;
    for(let m=0;m<cfg.entradaParc;m++){const idx=saleMonth+m;ensureLen(targetArray,idx+1);targetArray[idx]+=entradaParcel;}
    for(let m=0;m<restParc;m++){const idx=saleMonth+cfg.entradaParc+m;ensureLen(targetArray,idx+1);targetArray[idx]+=restanteTotal/restParc;}
  }
  function distributeUnits(units,startMonth,arr){for(let u=0;u<units;u++){addSalePayments(startMonth+u,price_unit,arr);}}
  distributeUnits(p.pre_launch_sales,0,receiptsPre);
  distributeUnits(p.launch_sales,p.pre_launch_sales,receiptsLaunch);
  let unitsSold=0,monthIdx=p.pre_launch_sales+p.launch_sales;
  while(unitsSold<p.units-(p.pre_launch_sales+p.launch_sales)){const unitsThisMonth=Math.min(p.monthly_sales,p.units-(p.pre_launch_sales+p.launch_sales)-unitsSold);distributeUnits(unitsThisMonth,monthIdx,receiptsMonthly);unitsSold+=unitsThisMonth;monthIdx++;if(monthIdx>1000) break;}
  const finalLen=Math.max(receiptsPre.length,receiptsLaunch.length,receiptsMonthly.length,p.months);
  const receipts=[],investments=[],costs=[];
  for(let i=0;i<finalLen;i++){receipts[i]=(receiptsPre[i]||0)+(receiptsLaunch[i]||0)+(receiptsMonthly[i]||0);}
  const incc=0.0045,den=(p.months*(p.months+1))/2;
  for(let m=1;m<=finalLen;m++){investments[m-1]=m<=p.months?(totalConstruction*(m/den))*Math.pow(1+incc,m):0;}
  for(let m=0;m<finalLen;m++){costs[m]=m<p.months?0.015*VGV/p.months+11000+((m===11)?0.01*VGV:0)+((m===0)?0.05*totalConstruction:0):0;}
  const net=receipts.map((r,i)=>r-(investments[i]||0)-(costs[i]||0));
  let cumul=0,payback='--';
  for(let i=0;i<net.length;i++){cumul+=net[i];if(cumul>=0){payback=i+1;break;}}
  const irrMonthly=irr(net),irrAnnual=isFinite(irrMonthly)?Math.pow(1+irrMonthly,12)-1:NaN;
  const rate=Math.pow(1+0.12,1/12)-1,npvVal=net.reduce((s,v,i)=>s+v/Math.pow(1+rate,i),0);
  const roi=totalConstruction===0?0:(net.reduce((s,v)=>s+v,0)/totalConstruction)*100;
  const cumFlow=[];net.reduce((s,v,i)=>{cumFlow[i]=s+v;return cumFlow[i];},0);
  const flow=[];for(let i=0;i<finalLen;i++)flow.push({month:'M'+(i+1),receita:receipts[i],invest:investments[i],net:net[i],cumul:cumFlow[i]});
  return {VGV,roi:roi.toFixed(1),tir:(irrAnnual*100).toFixed(1),VLP:npvVal.toFixed(2),payback,flow};
}

// ===== Renderização =====
function renderProjects(){
  const list=document.getElementById('projectsList');
  list.innerHTML='';
  projects.forEach(p=>{
    const card=document.createElement('div');
    card.className='project-card';
    const info=document.createElement('div'); info.className='info';
    const title=document.createElement('input'); title.type='text'; title.value=p.name;
    title.addEventListener('input',e=>{p.name=e.target.value;renderPortfolioChart();});
    info.appendChild(title);
    const city=document.createElement('div'); city.className='small'; city.textContent=p.city; info.appendChild(city);
    const kpis=document.createElement('div'); kpis.className='kpi';
    const res=computeProject(p);
    ['VGV','ROI','TIR','Payback'].forEach((k,idx)=>{
      const it=document.createElement('div'); it.className='item';
      const v=document.createElement('div'); v.className='value';
      v.textContent=k==='VGV'?`R$ ${res.VGV.toLocaleString()}`:res[k.toLowerCase()];
      it.innerHTML=`<div>${k}</div>`; it.appendChild(v); kpis.appendChild(it);
    });
    card.appendChild(info); card.appendChild(kpis);
    card.addEventListener('click',()=>renderDetail(p));
    list.appendChild(card);
  });
}
let portfolioChart;
function renderPortfolioChart(){
  const ctx=document.getElementById('chartPortfolio').getContext('2d');
  const labels=projects.map(p=>p.name);
  const data=projects.map(p=>computeProject(p).VGV);
  document.getElementById('totalVgv').textContent='R$ '+data.reduce((a,b)=>a+b,0).toLocaleString();
  if(portfolioChart) portfolioChart.destroy();
  portfolioChart=new Chart(ctx,{type:'bar',data:{labels, datasets:[{label:'VGV',data,backgroundColor:colors}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});
}
function renderDetail(p){
  const area=document.getElementById('detailArea');
  area.innerHTML='';
  const card=document.createElement('div'); card.className='card';
  card.innerHTML=`<div class="section-title">${p.name}</div>`;
  const res=computeProject(p);
  const table=document.createElement('table');
  const thead=document.createElement('thead');
  thead.innerHTML='<tr><th>Mês</th><th>Receita</th><th>Investimento</th><th>Fluxo Líquido</th><th>Acumulado</th></tr>'; table.appendChild(thead);
  const tbody=document.createElement('tbody');
  res.flow.forEach(f=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${f.month}</td><td>R$ ${f.receita.toFixed(2)}</td><td>R$ ${f.invest.toFixed(2)}</td><td>R$ ${f.net.toFixed(2)}</td><td>R$ ${f.cumul.toFixed(2)}</td>`;tbody.appendChild(tr);});
  table.appendChild(tbody); card.appendChild(table);
  const canvas=document.createElement('canvas'); canvas.height=140; card.appendChild(canvas);
  area.appendChild(card);
  const ctx=canvas.getContext('2d');
  new Chart(ctx,{type:'line',data:{labels:res.flow.map(f=>f.month),datasets:[{label:'Receita',data:res.flow.map(f=>f.receita),borderColor:'#4caf50',tension:0.3},{label:'Investimento',data:res.flow.map(f=>f.invest),borderColor:'#f44336',tension:0.3},{label:'Fluxo Líquido',data:res.flow.map(f=>f.net),borderColor:'#ffc107',tension:0.3}]},options:{plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true}}}});
}

// ===== Login =====
document.getElementById('btnLogin').addEventListener('click',()=>{
  const v=document.getElementById('pwd').value;
  if(v===PASSWORD){document.getElementById('loginModal').style.display='none';document.getElementById('app').style.display='flex';loadCfg();renderProjects();renderPortfolioChart();}
  else alert('Senha incorreta');
});

// ===== Eventos =====
document.getElementById('btnNew').addEventListener('click',()=>{projects.push({id:Date.now(),name:"Novo Projeto",city:"Cidade",units:10,area:80,price_m2:5000,cost_m2:2500,months:24,pre_launch_sales:0,launch_sales:0,monthly_sales:1});renderProjects();renderPortfolioChart();});
document.getElementById('btnPublish').addEventListener('click',()=>{saveCfg();renderProjects();renderPortfolioChart();alert('Alterações salvas localmente');});
document.getElementById('btnDownloadCsv').addEventListener('click',()=>{
  const rows=[['Projeto','Mês','Receita','Investimento','Fluxo Líquido','Acumulado']];
  projects.forEach(p=>{const f=computeProject(p).flow; f.forEach(r=>rows.push([p.name,r.month,r.receita.toFixed(2),r.invest.toFixed(2),r.net.toFixed(2),r.cumul.toFixed(2)]));});
  const csvContent='data:text/csv;charset=utf-8,'+rows.map(e=>e.join(',')).join('\n');
  const encodedUri=encodeURI(csvContent); const link=document.createElement('a'); link.setAttribute('href',encodedUri); link.setAttribute('download','portfolio.csv'); document.body.appendChild(link); link.click(); document.body.removeChild(link);
});
document.getElementById('entradaPct').addEventListener('change',saveCfg);
document.getElementById('entradaParc').addEventListener('change',saveCfg);
document.getElementById('parcelasRestantes').addEventListener('change',saveCfg);
document.getElementById('search').addEventListener('input',e=>{const v=e.target.value.toLowerCase();projects.forEach((p,i)=>{const card=document.getElementById('projectsList').children[i];card.style.display=p.name.toLowerCase().includes(v)?'flex':'none';})});
</script>

</body>
</html>
