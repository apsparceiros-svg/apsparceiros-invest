<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707; --panel:#0f0f0f; --muted:#9e9e9e; --gold:#c9a84b; --card:#121212; --accent:#e6e6e6; --alert:#ffcc00;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column;position:relative}
.project-card .info{flex:1;width:100%}
.project-card input.modified{border:2px solid var(--alert);}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center;position:relative}
.kpi .item.alert::after{content:"⚠";position:absolute;top:2px;right:4px;color:var(--alert);}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color: #1e1e1e; color: #fff; border: 1px solid #c9a84b; padding: 6px 8px; border-radius: 6px; width: 100%; margin-bottom:6px;
}
.project-card input[type=text]:focus,
.project-card input[type=number]:focus{outline:2px solid #c9a84b;background-color:#292929;}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>
<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por indicador</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label class="small">Mostrar</label>
        <select id="showIndicators"><option value="all">Todos</option><option value="vgv">VGV</option><option value="irr">TIR</option></select>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0">

        <div><strong>Condições de Venda</strong></div>
        <label>Desconto Pré-lançamento (%)</label>
        <input id="discountPre" type="number" min="0" max="100" step="0.1" value="10">
        <label>Desconto Lançamento (%)</label>
        <input id="discountLaunch" type="number" min="0" max="100" step="0.1" value="5">

        <label>Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">

        <label>Parcelas da entrada (nº)</label>
        <input id="entradaMonths" type="number" min="1" step="1" value="6">

        <label>Parcelas do saldo (nº)</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">

        <div class="small" style="margin-top:6px">A entrada é paga em X parcelas a partir do mês da venda; o restante (saldo) é pago em Y parcelas subsequentes.</div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tooltip"><button id="btnHelp" class="button ghost">Legenda</button><div class="tt"><strong>ROI</strong>: retorno sobre o capital investido.<br><strong>TIR</strong>: taxa interna de retorno anualizada.<br><strong>Payback</strong>: meses para recuperar o aporte.</div></div>
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="vgvTotal">0</div>
            </div>
          </div>
          <canvas id="chartPortfolio" height="150"></canvas>
        </div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Comparação de Projetos</strong><div class="small">Selecione até 3 projetos</div></div>
          </div>
          <canvas id="chartCompare" height="180"></canvas>
        </div>
      </section>
      <aside>
        <div class="card" id="projectDetail">
          <strong>Selecione um projeto</strong>
          <div class="small">Para visualizar KPIs e fluxo de caixa</div>
        </div>
      </aside>
    </div>
  </main>
</div>

<script>
/*==================== Login ====================*/
const pwdField=document.getElementById('pwd'), loginModal=document.getElementById('loginModal');
document.getElementById('btnLogin').addEventListener('click',()=>{
  if(pwdField.value==='Investidor'){loginModal.style.display='none';document.getElementById('app').style.display='flex';}else{alert('Senha incorreta');}
});
/*==================== Helpers ====================*/
function formatMoney(v){return v.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});}
function debounce(fn,delay=300){let t; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),delay);}}

/*==================== Project Class ====================*/
class Project{
  constructor(data){Object.assign(this,data);this.results=null;}
  compute(cfg){
    const months=this.months||24;
    const price_unit_full=this.area*this.price_m2;
    const VGV=this.units*price_unit_full;
    const totalConstruction=this.units*this.area*this.cost_m2;
    const receiptsPre=[], receiptsLaunch=[], receiptsMonthly=[], investments=[], costs=[];
    function ensureLen(arr,len){while(arr.length<len) arr.push(0);}
    function addSalePayments(saleMonth,price_unit,targetArray){
      const entradaPct=(cfg.entradaPct||30)/100;
      const entradaMonths=cfg.entradaMonths||6;
      const entradaTotal=price_unit*entradaPct;
      const entradaParcel=entradaTotal/entradaMonths;
      const restanteTotal=price_unit*(1-entradaPct);
      const restParc=cfg.parcelasRestantes||24;
      for(let m=0;m<entradaMonths;m++){ensureLen(targetArray,saleMonth+m+1);targetArray[saleMonth+m]+=entradaParcel;}
      for(let m=0;m<restParc;m++){ensureLen(targetArray,saleMonth+entradaMonths+m+1);targetArray[saleMonth+entradaMonths+m]+=restanteTotal/restParc;}
    }
    function distributeUnits(units,startMonth,targetArray,type){
      for(let u=0;u<units;u++){
        let price=price_unit_full;
        if(type==='pre') price*=(1-(cfg.discountPre||0)/100);
        if(type==='launch') price*=(1-(cfg.discountLaunch||0)/100);
        addSalePayments(startMonth+u,price,targetArray);
      }
    }
    distributeUnits(this.pre_launch_sales||0,0,receiptsPre,'pre');
    distributeUnits(this.launch_sales||0,this.pre_launch_sales||0,receiptsLaunch,'launch');
    let unitsSoldMonthly=0, monthIdx=(this.pre_launch_sales||0)+(this.launch_sales||0);
    while(unitsSoldMonthly<this.units-((this.pre_launch_sales||0)+(this.launch_sales||0))){
      const uThisMonth=Math.min(this.monthly_sales||0,this.units-((this.pre_launch_sales||0)+(this.launch_sales||0))-unitsSoldMonthly);
      distributeUnits(uThisMonth,monthIdx,receiptsMonthly,'monthly');
      unitsSoldMonthly+=uThisMonth; monthIdx++; if(monthIdx>1000) break;
    }
    const finalLen=Math.max(receiptsPre.length,receiptsLaunch.length,receiptsMonthly.length,months);
    const incc=0.0045, den=(months*(months+1))/2;
    for(let m=1;m<=finalLen;m++){ investments[m-1]=m<=months?totalConstruction*m/den*Math.pow(1+incc,m):0; }
    for(let m=0;m<finalLen;m++){costs[m]=0;if(m<months){costs[m]+=0.015*VGV;costs[m]+=8000+3000;if(m===11) costs[m]+=0.01*VGV;if(m===0) costs[m]+=0.05*totalConstruction;}}
    const receipts=[];
    for(let i=0;i<finalLen;i++){receipts[i]=(receiptsPre[i]||0)+(receiptsLaunch[i]||0)+(receiptsMonthly[i]||0);}
    const net=receipts.map((r,i)=>r-(investments[i]||0)-(costs[i]||0));
    const irrMonthly=irr(net); const irrAnnual=isFinite(irrMonthly)?Math.pow(1+irrMonthly,12)-1:NaN;
    let cumul=0, payback='--';for(let i=0;i<net.length;i++){cumul+=net[i];if(cumul>=0){payback=i+1;break;}}
    const totalNet=net.reduce((s,v)=>s+v,0), totalInvestment=investments.reduce((s,v)=>s+v,0);
    const roi=totalInvestment===0?0:(totalNet/totalInvestment)*100;
    this.results={VGV,totalConstruction,roi,irrAnnual,npvVal:net.reduce((s,v,i)=>s+v/Math.pow(1+Math.pow(1+0.12,1/12)-1,i),0),payback,receiptsPre,receiptsLaunch,receiptsMonthly,receipts,investments,costs,net};
    return this.results;
  }
}

/*==================== IRR Function ====================*/
function irr(values, guess=0.1){
  const maxIter=1000, tol=1e-6;
  let rate=guess;
  for(let i=0;i<maxIter;i++){
    let npv=0,dnpv=0;
    for(let t=0;t<values.length;t++){npv+=values[t]/Math.pow(1+rate,t);dnpv-=t*values[t]/Math.pow(1+rate,t+1);}
    const newRate=rate-npv/dnpv;if(Math.abs(newRate-rate)<tol)return newRate;rate=newRate;
  }
  return NaN;
}

/*==================== App State ====================*/
let projects=[], cfg={}, selectedCompare=[];

/*==================== DOM References ====================*/
const projectsList=document.getElementById('projectsList'),
      projectDetail=document.getElementById('projectDetail'),
      discountPreInput=document.getElementById('discountPre'),
      discountLaunchInput=document.getElementById('discountLaunch'),
      entradaPctInput=document.getElementById('entradaPct'),
      entradaMonthsInput=document.getElementById('entradaMonths'),
      parcelasRestantesInput=document.getElementById('parcelasRestantes'),
      btnNew=document.getElementById('btnNew'),
      searchInput=document.getElementById('search'),
      chartPortfolioCanvas=document.getElementById('chartPortfolio'),
      chartCompareCanvas=document.getElementById('chartCompare'),
      vgvTotalSpan=document.getElementById('vgvTotal');

/*==================== Config ====================*/
function updateCfg(){
  cfg={discountPre:Number(discountPreInput.value),
       discountLaunch:Number(discountLaunchInput.value),
       entradaPct:Number(entradaPctInput.value),
       entradaMonths:Number(entradaMonthsInput.value),
       parcelasRestantes:Number(parcelasRestantesInput.value)};
  projects.forEach(p=>p.compute(cfg));
  renderProjects(); renderPortfolioChart(); renderCompareChart();
}
[discountPreInput,discountLaunchInput,entradaPctInput,entradaMonthsInput,parcelasRestantesInput].forEach(input=>{
  input.addEventListener('input',debounce(updateCfg,300));
});

/*==================== Render Functions ====================*/
function renderProjects(){
  projectsList.innerHTML='';
  projects.forEach((p,i)=>{
    const card=document.createElement('div'); card.className='project-card';
    card.innerHTML=`
      <div class="info">
        <strong>${p.name}</strong>
        <div class="small">Unidades: ${p.units} | Área: ${p.area} m² | Custo m²: ${p.cost_m2}</div>
      </div>
      <div class="kpi">
        <div class="item ${p.results.roi<10?'alert':''}"><div class="small">ROI</div><div class="value">${p.results.roi.toFixed(1)}%</div></div>
        <div class="item ${p.results.irrAnnual<0.05?'alert':''}"><div class="small">TIR</div><div class="value">${(p.results.irrAnnual*100).toFixed(1)}%</div></div>
        <div class="item ${p.results.payback>24?'alert':''}"><div class="small">Payback</div><div class="value">${p.results.payback}</div></div>
      </div>
    `;
    card.addEventListener('click',()=>{renderProjectDetail(p); toggleCompare(i);});
    projectsList.appendChild(card);
  });
}

function renderProjectDetail(p){
  projectDetail.innerHTML=`
    <strong>${p.name}</strong>
    <div class="small">Detalhes e Fluxo de Caixa</div>
    <div class="kpi" style="margin-top:10px">
      <div class="item"><div class="small">ROI</div><div class="value">${p.results.roi.toFixed(1)}%</div></div>
      <div class="item"><div class="small">TIR</div><div class="value">${(p.results.irrAnnual*100).toFixed(1)}%</div></div>
      <div class="item"><div class="small">Payback</div><div class="value">${p.results.payback}</div></div>
    </div>
  `;
}

/*==================== Charts ====================*/
let chartPortfolio=null, chartCompare=null;

function renderPortfolioChart(){
  const labels=projects.map((p,i)=>p.name);
  const data=projects.map(p=>p.results.VGV);
  vgvTotalSpan.innerText=formatMoney(data.reduce((s,v)=>s+v,0));
  if(chartPortfolio) chartPortfolio.destroy();
  chartPortfolio=new Chart(chartPortfolioCanvas,{type:'bar',data:{labels, datasets:[{label:'VGV',data,backgroundColor:'#c9a84b'}]},options:{plugins:{legend:{display:false}}}});
}

function toggleCompare(idx){
  if(selectedCompare.includes(idx)) selectedCompare=selectedCompare.filter(x=>x!==idx);
  else{if(selectedCompare.length<3) selectedCompare.push(idx);}
  renderCompareChart();
}

function renderCompareChart(){
  if(chartCompare) chartCompare.destroy();
  const labels=[]; const datasets=[];
  selectedCompare.forEach(i=>{
    const p=projects[i]; if(!p) return;
    labels.length=p.results.net.length; for(let j=0;j<p.results.net.length;j++) labels[j]=`M${j+1}`;
    datasets.push({label:p.name,data:p.results.net,fill:false,borderColor:'#c9a84b',tension:0.3});
  });
  chartCompare=new Chart(chartCompareCanvas,{type:'line',data:{labels,datasets},options:{plugins:{legend:{display:true}}}});
}

/*==================== Add Project ====================*/
btnNew.addEventListener('click',()=>{
  const name=prompt('Nome do projeto:'); if(!name) return;
  const p=new Project({name,units:10,area:80,cost_m2:3500,pre_launch_sales:2,launch_sales:3,monthly_sales:1,months:24});
  p.compute(cfg); projects.push(p); renderProjects(); renderPortfolioChart();
});

/*==================== Demo Initial Data ====================*/
function demoData(){
  const p1=new Project({name:'Residencial Sol',units:10,area:85,cost_m2:3800,pre_launch_sales:2,launch_sales:3,monthly_sales:1,months:24});
  const p2=new Project({name:'Edifício Lua',units:12,area:70,cost_m2:3600,pre_launch_sales:1,launch_sales:4,monthly_sales:1,months:24});
  const p3=new Project({name:'Vila Estrela',units:8,area:95,cost_m2:4000,pre_launch_sales:2,launch_sales:2,monthly_sales:1,months:24});
  projects=[p1,p2,p3];
  updateCfg();
}
demoData();

/*==================== Search ====================*/
searchInput.addEventListener('input',debounce(()=>{
  const term=searchInput.value.toLowerCase();
  document.querySelectorAll('.project-card').forEach((card,i)=>{
    card.style.display=projects[i].name.toLowerCase().includes(term)?'flex':'none';
  });
},300));

</script>
</body>
</html>
