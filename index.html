<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Simulador de Projetos Imobiliários</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body{font-family:sans-serif;background:#1e1e1e;color:#fff;margin:0;padding:0}
.container{display:flex;gap:12px;padding:12px}
.sidebar{width:360px;overflow-y:auto;max-height:90vh}
.project-card{background:#2e2e2e;padding:8px;margin-bottom:8px;border-radius:6px;cursor:pointer}
.project-card:hover{background:#3e3e3e}
.kpi{display:flex;gap:8px;margin-top:6px}
.kpi .item{flex:1;background:#3a3a3a;padding:4px;border-radius:4px;text-align:center}
.small{font-size:11px;color:#ccc}
.value{font-weight:600;color:#ffd700}
.card{background:#2a2a2a;padding:8px;border-radius:6px;margin-bottom:8px}
input[type=number]{-moz-appearance:textfield;}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
button{cursor:pointer}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;overflow:auto}
.modal-content{background:#2a2a2a;padding:16px;border-radius:8px;width:90%;max-width:1200px;max-height:90vh;overflow-y:auto;position:relative;display:flex;flex-direction:column;gap:12px}
.modal-close{position:absolute;top:12px;right:16px;font-size:24px;cursor:pointer;color:#fff}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:8px}
.tab{padding:6px 12px;border-radius:4px;background:#3a3a3a;cursor:pointer}
.tab.active{background:#ffd700;color:#000;font-weight:bold}
.tab-content{flex:1;overflow:auto}
.tab-total{margin-top:6px;font-weight:bold}

/* Charts responsive */
canvas{width:100% !important; height:auto !important; max-height:300px}
</style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <input type="text" id="search" placeholder="Pesquisar projeto..." style="width:100%;margin-bottom:8px;padding:4px;border-radius:4px;border:none">
    <div id="projectsList"></div>
    <div class="card">
      <strong>Resumo Portfólio</strong>
      <canvas id="chartPortfolio" height="200"></canvas>
      <div style="margin-top:6px">
        <div>Total VGV: <span id="totalVgv">0</span></div>
        <div>ROI médio: <span id="avgRoi">0</span></div>
        <div>TIR média: <span id="avgIrr">0</span></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="projectModal" class="modal">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modalBody"></div>
  </div>
</div>

<script>
// ======= Configurações =======
const colors=['#c9a84b','#b58f3a','#d9b86b','#8bc34a','#2196f3','#9c27b0'];
let saleCfg = { discountPre:10, discountLaunch:5, parcelasRestantes:24, entradaPct:30, entradaMonths:6 };
let projects = [];

// ======= Classe Project =======
class Project {
  constructor(data){ Object.assign(this,data); this.compute(); }
  compute(){
    const cfg=saleCfg;
    const months=this.months;
    const price_unit_full=this.area*this.price_m2;
    const VGV=this.units*price_unit_full;
    const totalConstruction=this.units*this.area*this.cost_m2;
    const receiptsPre=[],receiptsLaunch=[],receiptsMonthly=[],investments=[],costs=[];
    const ensureLen=(arr,len)=>{ while(arr.length<len) arr.push(0); }
    const addSalePayments=(saleMonth,price_unit,targetArray)=>{
      const entradaPct=cfg.entradaPct/100,entradaMonths=cfg.entradaMonths;
      const entradaTotal=price_unit*entradaPct;
      const entradaParcel=entradaTotal/entradaMonths;
      const restanteTotal=price_unit*(1-entradaPct);
      const restParc=cfg.parcelasRestantes;
      for(let m=0;m<entradaMonths;m++){ const idx=saleMonth+m; ensureLen(targetArray,idx+1); targetArray[idx]+=entradaParcel; }
      for(let m=0;m<restParc;m++){ const idx=saleMonth+entradaMonths+m; ensureLen(targetArray,idx+1); targetArray[idx]+=restanteTotal/restParc; }
    }
    const distributeUnits=(units,startMonth,arr,type)=>{
      for(let u=0;u<units;u++){
        const saleMonth=startMonth+u;
        let price_unit=price_unit_full;
        if(type==='pre' && cfg.discountPre) price_unit*=(1-cfg.discountPre/100);
        if(type==='launch' && cfg.discountLaunch) price_unit*=(1-cfg.discountLaunch/100);
        addSalePayments(saleMonth,price_unit,arr);
      }
    }
    distributeUnits(this.pre_launch_sales,0,receiptsPre,'pre');
    distributeUnits(this.launch_sales,this.pre_launch_sales,receiptsLaunch,'launch');
    let unitsSoldMonthly=0, monthIdx=this.pre_launch_sales+this.launch_sales;
    while(unitsSoldMonthly<this.units-(this.pre_launch_sales+this.launch_sales)){
      const unitsThisMonth=Math.min(this.monthly_sales,this.units-(this.pre_launch_sales+this.launch_sales)-unitsSoldMonthly);
      distributeUnits(unitsThisMonth,monthIdx,receiptsMonthly,'monthly');
      unitsSoldMonthly+=unitsThisMonth; monthIdx++; if(monthIdx>1000) break;
    }
    const finalLen=Math.max(receiptsPre.length,receiptsLaunch.length,receiptsMonthly.length,months);
    const incc=0.0045, den=(months*(months+1))/2;
    for(let m=1;m<=finalLen;m++){
      investments[m-1]=m<=months?totalConstruction*(m/den)*Math.pow(1+incc,m):0;
      costs[m-1]=0;
      if(m<=months){ costs[m-1]+=0.015*VGV/months+8000+3000; if(m===11) costs[m-1]+=0.01*VGV; if(m===1) costs[m-1]+=0.05*totalConstruction; }
    }
    const receipts=[]; for(let i=0;i<finalLen;i++){ receipts[i]=(receiptsPre[i]||0)+(receiptsLaunch[i]||0)+(receiptsMonthly[i]||0); }
    const net=receipts.map((r,i)=>r-(investments[i]||0)-(costs[i]||0));
    const irrMonthly=irr(net);
    const irrAnnual=isFinite(irrMonthly)?Math.pow(1+irrMonthly,12)-1:NaN;
    const rate=Math.pow(1+0.12,1/12)-1;
    const npvVal=net.reduce((s,v,i)=>s+v/Math.pow(1+rate,i),0);
    let cumul=0,payback='--'; for(let i=0;i<net.length;i++){ cumul+=net[i]; if(cumul>=0){payback=i+1;break;} }
    const totalNet=net.reduce((s,v)=>s+v,0); const roi=totalConstruction===0?0:(totalNet/totalConstruction)*100;
    this._computed={receiptsPre,receiptsLaunch,receiptsMonthly,receipts,investments,costs,net,irrMonthly,irrAnnual,npvVal,payback,roi,VGV,totalConstruction,marketingTotal:0.015*VGV,brokerTotal:0.05*VGV};
  }
  getComputed(){ return this._computed; }
}

// ======= IRR =======
function irr(values, guess = 0.01) {
  const eps=1e-7,maxIter=1000; let rate=guess;
  const npv=r=>values.reduce((s,v,i)=>s+v/Math.pow(1+r,i),0);
  const dnpv=r=>values.reduce((s,v,i)=>s-i*v/Math.pow(1+r,i+1),0);
  for(let i=0;i<maxIter;i++){ const f=npv(rate),df=dnpv(rate); if(Math.abs(df)<1e-12) break; const nr=rate-f/df; if(Math.abs(nr-rate)<eps) return rate; rate=nr; }
  let low=-0.999,high=10; for(let i=0;i<200;i++){ const mid=(low+high)/2; const v=npv(mid); if(Math.abs(v)<1e-6) return mid; if(v>0) low=mid; else high=mid; }
  return rate;
}

// ======= Render Sidebar =======
let portfolioChart=null;
function renderSidebar(){
  const el=document.getElementById('projectsList'); el.innerHTML='';
  projects.forEach(p=>{
    const d=p.getComputed();
    const div=document.createElement('div'); div.className='project-card';
    div.innerHTML=`<strong>${p.name}</strong><div class="small">${p.city}</div>
      <div class="kpi">
        <div class="item"><div class="small">VGV</div><div class="value">${d.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
        <div class="item"><div class="small">ROI</div><div class="value">${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}</div></div>
        <div class="item"><div class="small">TIR</div><div class="value">${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}</div></div>
      </div>`;
    div.addEventListener('click',()=>openModal(p));
    el.appendChild(div);
  });
  updatePortfolioChart();
}

// ======= Portfolio Chart =======
function updatePortfolioChart(){
  const totals=projects.map(p=>p.getComputed().VGV);
  const ctx=document.getElementById('chartPortfolio').getContext('2d');
  if(portfolioChart){ portfolioChart.data.datasets[0].data=totals; portfolioChart.update(); }
  else portfolioChart=new Chart(ctx,{type:'doughnut',data:{labels:projects.map(p=>p.name),datasets:[{data:totals,backgroundColor:colors}]},options:{plugins:{legend:{position:'bottom',labels:{color:'#fff'}}}}});
  document.getElementById('totalVgv').innerText=totals.reduce((s,v)=>s+v,0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
  const avgRoi=projects.reduce((s,p)=>s+p.getComputed().roi,0)/projects.length;
  const avgIrr=projects.reduce((s,p)=>s+p.getComputed().irrAnnual,0)/projects.length;
  document.getElementById('avgRoi').innerText=isFinite(avgRoi)?avgRoi.toFixed(1)+'%':'--';
  document.getElementById('avgIrr').innerText=isFinite(avgIrr)?(avgIrr*100).toFixed(1)+'%':'--';
}

// ======= Modal =======
function openModal(p){
  const d=p.getComputed();
  const modalBody=document.getElementById('modalBody');
  
  modalBody.innerHTML=`
    <h2>${p.name} - ${p.city}</h2>
    <div class="kpi" style="gap:16px;margin-bottom:12px">
      <div class="item"><div class="small">ROI</div><div class="value">${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}</div></div>
      <div class="item"><div class="small">TIR (a.a.)</div><div class="value">${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}</div></div>
      <div class="item"><div class="small">VPL (12% a.a.)</div><div class="value">${d.npvVal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
      <div class="item"><div class="small">Payback</div><div class="value">${d.payback} meses</div></div>
    </div>
    <div class="tabs">
      <div class="tab active" onclick="showTab('receitas')">Receitas</div>
      <div class="tab" onclick="showTab('custos')">Custos</div>
      <div class="tab" onclick="showTab('net')">Fluxo Líquido</div>
    </div>
    <div class="tab-content" id="tabContent"></div>
  `;
  
  // Charts para cada aba
  const tabData={
    receitas:{labels:Array.from({length:d.net.length},(_,i)=>'M'+(i+1)),
              datasets:[
                {label:'Pré-lançamento',data:d.receiptsPre,borderColor:'#ff9800',backgroundColor:'rgba(255,152,0,0.2)',fill:true,tension:0.3},
                {label:'Lançamento',data:d.receiptsLaunch,borderColor:'#4caf50',backgroundColor:'rgba(76,175,80,0.2)',fill:true,tension:0.3},
                {label:'Vendas Mensais',data:d.receiptsMonthly,borderColor:'#2196f3',backgroundColor:'rgba(33,150,243,0.2)',fill:true,tension:0.3}]},
    custos:{labels:Array.from({length:d.costs.length},(_,i)=>'M'+(i+1)),
            datasets:[
              {label:'Investimentos',data:d.investments,borderColor:'#f44336',fill:false,tension:0.3},
              {label:'Custos',data:d.costs,borderColor:'#9c27b0',fill:false,tension:0.3}]},
    net:{labels:Array.from({length:d.net.length},(_,i)=>'M'+(i+1)),
         datasets:[{label:'Net',data:d.net,borderColor:'#ffc107',fill:false,tension:0.3}]}
  };
  
  function drawChart(tab){
    const container=document.getElementById('tabContent');
    container.innerHTML=`<canvas id="modalChart" style="width:100%;height:300px;"></canvas>`;
    const ctx=document.getElementById('modalChart').getContext('2d');
    new Chart(ctx,{
      type:'line',
      data:tabData[tab],
      options:{plugins:{legend:{labels:{color:'#fff'}}},scales:{y:{ticks:{color:'#fff'}},x:{ticks:{color:'#fff'}}}}
    });
    // Total
    let total=0;
    if(tab==='receitas') total=d.receipts.reduce((a,b)=>a+b,0);
    if(tab==='custos') total=d.costs.reduce((a,b)=>a+b,0);
    if(tab==='net') total=d.net.reduce((a,b)=>a+b,0);
    const totalDiv=document.createElement('div'); totalDiv.className='tab-total'; totalDiv.innerHTML=`Total: ${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}`;
    container.appendChild(totalDiv);
  }
  
  window.showTab=function(tab){
    document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
    document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add('active');
    drawChart(tab);
  }
  
  showTab('receitas');
  document.getElementById('projectModal').style.display='flex';
}
function closeModal(){document.getElementById('projectModal').style.display='none';}

// ======= Mock Projects =======
function generateProjects(){
  projects=[
    new Project({id:1,name:'Residencial Alpha',city:'São Paulo',units:120,area:65,price_m2:8500,cost_m2:4500,months:18,pre_launch_sales:10,launch_sales:20,monthly_sales:5}),
    new Project({id:2,name:'Cond. Beta',city:'Rio de Janeiro',units:90,area:80,price_m2:7500,cost_m2:4000,months:20,pre_launch_sales:5,launch_sales:15,monthly_sales:4}),
    new Project({id:3,name:'Torres Gamma',city:'Belo Horizonte',units:60,area:70,price_m2:8200,cost_m2:4300,months:16,pre_launch_sales:8,launch_sales:12,monthly_sales:3}),
    new Project({id:4,name:'Jardins Delta',city:'Curitiba',units:50,area:85,price_m2:9000,cost_m2:5000,months:18,pre_launch_sales:5,launch_sales:10,monthly_sales:2})
  ];
}

// ======= Inicialização =======
generateProjects(); renderSidebar();
</script>
</body>
</html>
