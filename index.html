<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#070707;--panel:#0f0f0f;--muted:#9e9e9e;--gold:#c9a84b;--card:#121212;--accent:#e6e6e6}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;justify-content:center;align-items:center;z-index:100;display:none}
.modal .modal-content{background:var(--panel);padding:18px;border-radius:12px;width:420px;max-height:90vh;overflow:auto}
.modal .modal-content h3{margin-top:0;color:var(--gold)}
.modal .modal-content label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.modal .modal-content input{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)}
.modal .modal-footer{margin-top:12px;display:flex;justify-content:flex-end;gap:8px}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<!-- Modal de Edição -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <h3>Editar Projeto</h3>
    <div id="modalFields"></div>
    <div class="modal-footer">
      <button id="btnCloseModal" class="button ghost">Cancelar</button>
      <button id="btnSaveModal" class="button">Salvar</button>
    </div>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por indicador</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Clique no projeto para editar e atualizar métricas.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1"><canvas id="chartPortfolio" height="120"></canvas></div>
            <div style="width:220px">
              <div class="kpi"><div class="item"><div class="small">ROI médio</div><div class="value" id="avgRoi">--</div></div><div class="item"><div class="small">TIR média</div><div class="value" id="avgIrr">--</div></div></div>
              <div style="margin-top:10px" class="small">Clique num projeto na lateral para editar.</div>
            </div>
          </div>
        </div>
        <div id="detailArea"></div>
      </section>

      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table style="width:100%"><tbody>
            <tr><td class="small">VGV</td><td class="small">Valor Geral de Vendas</td></tr>
            <tr><td class="small">ROI</td><td class="small">Retorno sobre o capital</td></tr>
            <tr><td class="small">TIR</td><td class="small">Taxa interna de retorno</td></tr>
            <tr><td class="small">Payback</td><td class="small">Meses para recuperar investimento</td></tr>
          </tbody></table>
        </div>
      </aside>
    </div>
  </main>
</div>

<script>
// --- Dados ---
let projects = [
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,sales_per_month:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,sales_per_month:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,sales_per_month:4}
];
const PASSWORD = "Investidor";

// ===== Funções financeiras =====
function irr(values, guess = 0.01) {
  const eps = 1e-7;
  const maxIter = 1000;
  let rate = guess;

  const npv = r => values.reduce((s, v, i) => s + v / Math.pow(1 + r, i), 0);
  const dnpv = r => values.reduce((s, v, i) => s - i * v / Math.pow(1 + r, i + 1), 0);

  // Método de Newton-Raphson
  for (let i = 0; i < maxIter; i++) {
    const f = npv(rate);
    const df = dnpv(rate);
    if (Math.abs(df) < 1e-12) break;
    const nr = rate - f / df;
    if (Math.abs(nr - rate) < eps) return rate;
    rate = nr;
  }

  // fallback: bissecção
  let low = -0.999, high = 10;
  for (let i = 0; i < 200; i++) {
    const mid = (low + high) / 2;
    const v = npv(mid);
    if (Math.abs(v) < 1e-6) return mid;
    if (v > 0) low = mid; else high = mid;
  }
  return rate;
}

function computeProject(p) {
  const months = p.months;
  const price_unit = p.area * p.price_m2;
  const VGV = p.units * price_unit;
  const salesMonths = Math.ceil(p.units / p.sales_per_month);

  const receipts = Array(months).fill(0);
  const investments = Array(months).fill(0);
  const costs = Array(months).fill(0);

  const incc = 0.0045; // índice de correção
  const den = (months * (months + 1)) / 2;
  const totalConstruction = p.units * p.area * p.cost_m2;

  // Investimentos mensais
  for (let m = 1; m <= months; m++) {
    const prop = m / den;
    const base = totalConstruction * prop;
    const invested = base * Math.pow(1 + incc, m);
    investments[m - 1] = invested;
  }

  // Recebimentos de vendas
  let sold = 0;
  for (let s = 1; s <= salesMonths; s++) {
    const unitsThis = Math.min(p.sales_per_month, p.units - sold);
    sold += unitsThis;
    for (let u = 0; u < unitsThis; u++) {
      const sinal = 0.10 * price_unit;
      const parcelTotal = 0.10 * price_unit;
      const parcelMonths = Math.max(1, months - s);
      const parcel = parcelTotal / parcelMonths;
      receipts[s - 1] += sinal;
      for (let mm = s; mm < months; mm++) receipts[mm] += parcel;
      receipts[months - 1] += 0.80 * price_unit;
    }
  }

  // Custos
  const VGV_total = VGV;
  const marketingTotal = 0.015 * VGV_total;
  const marketingMonthly = marketingTotal / 12;
  const brokerTotal = 0.05 * VGV_total;
  const brokerPerUnit = brokerTotal / p.units;

  let sold2 = 0;
  const saleSchedule = [];
  for (let s = 1; s <= salesMonths; s++) {
    const unitsThis = Math.min(p.sales_per_month, p.units - sold2);
    sold2 += unitsThis;
    saleSchedule.push({ month: s, units: unitsThis });
  }
  for (const ss of saleSchedule) { costs[ss.month - 1] += ss.units * brokerPerUnit; }
  for (let m = 1; m <= months; m++) {
    if (m <= 12) costs[m - 1] += marketingMonthly;
    if (m === 12) costs[m - 1] += 0.01 * VGV_total;
    costs[m - 1] += 8000 + 3000; // custos fixos gerais
    if (m === 1) costs[m - 1] += 0.05 * totalConstruction;
  }

  // Fluxo líquido
  const net = receipts.map((r, i) => r - investments[i] - costs[i]);
  const irrMonthly = irr(net);
  const irrAnnual = Math.pow(1 + irrMonthly, 12) - 1;
  const rate = Math.pow(1 + 0.12, 1 / 12) - 1;
  const npvVal = net.reduce((s, v, i) => s + v / Math.pow(1 + rate, i), 0);

  // Payback
  let cumul = 0;
  let payback = '--';
  for (let i = 0; i < net.length; i++) { cumul += net[i]; if (cumul >= 0) { payback = i + 1; break; } }

  const totalNet = net.reduce((s, v) => s + v, 0);
  const roi = investments.reduce((s, v) => s + v, 0) === 0 ? 0 : (totalNet / investments.reduce((s, v) => s + v, 0)) * 100;

  return {
    receipts,
    investments,
    costs,
    net,
    irrMonthly,
    irrAnnual,
    npvVal,
    payback,
    roi,
    VGV,
    totalConstruction,
    marketingTotal,
    brokerTotal
  };
}

// --- Render sidebar ---
function renderSidebar(){
  const el = document.getElementById('projectsList');
  el.innerHTML = '';
  projects.forEach(p=>{
    const metrics = computeProject(p);
    const div = document.createElement('div');
    div.className='project-card';
    div.innerHTML = `<div>${p.name}<br><span class="small">${p.city}</span></div>
      <div class="kpi">
        <div class="item"><div class="small">VGV</div><div class="value">${metrics.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
        <div class="item"><div class="small">ROI</div><div class="value">${metrics.roi.toFixed(1)}%</div></div>
        <div class="item"><div class="small">TIR</div><div class="value">${(metrics.irrAnnual*100).toFixed(1)}%</div></div>
      </div>`;
    div.addEventListener('click',()=>openModal(p.id));
    el.appendChild(div);
  });
  updatePortfolioChart();
}

// --- Modal ---
let currentEditingId=null;
function openModal(id){
  currentEditingId=id;
  const p = projects.find(x=>x.id===id);
  const modalFields=document.getElementById('modalFields');
  modalFields.innerHTML='';
  for(const key of ['name','city','units','area','price_m2','cost_m2','months','sales_per_month']){
    const label=document.createElement('label');
    label.textContent=key.charAt(0).toUpperCase() + key.slice(1).replace('_',' ');
    const input=document.createElement('input');
    input.value=p[key];
    input.dataset.field=key;
    if(typeof p[key]==='number') input.type='number'; else input.type='text';
    modalFields.appendChild(label);
    modalFields.appendChild(input);
  }
  document.getElementById('editModal').style.display='flex';
}
document.getElementById('btnCloseModal').addEventListener('click',()=>document.getElementById('editModal').style.display='none');
document.getElementById('btnSaveModal').addEventListener('click',()=>{
  const p = projects.find(x=>x.id===currentEditingId);
  document.querySelectorAll('#modalFields input').forEach(input=>{
    const val=input.type==='number'?Number(input.value):input.value;
    p[input.dataset.field]=val;
  });
  document.getElementById('editModal').style.display='none';
  renderSidebar();
});

// --- Eventos ---
document.getElementById('btnLogin').addEventListener('click',()=>{
  const v=document.getElementById('pwd').value;
  if(v===PASSWORD){
    document.getElementById('loginModal').style.display='none';
    document.getElementById('app').style.display='flex';
    const saved=localStorage.getItem('aps_projects');
    if(saved) try{projects=JSON.parse(saved);}catch(e){}
    renderSidebar();
  }else alert('Senha incorreta');
});
document.getElementById('btnExport').addEventListener('click',exportJson);
document.getElementById('btnPublish').addEventListener('click',saveAll);
document.getElementById('btnReset').addEventListener('click',()=>{if(confirm('Restaurar valores iniciais?')){localStorage.removeItem('aps_projects');location.reload();}});
document.getElementById('btnNew').addEventListener('click',()=>{const id=projects.length+1;projects.push({id:id,name:'Novo Empreendimento '+id,city:'Cidade',units:10,area:70,price_m2:5000,cost_m2:2000,months:18,sales_per_month:2});renderSidebar();});
document.getElementById('btnDownloadCsv').addEventListener('click',downloadCsv);
window.addEventListener('load',()=>{const saved=localStorage.getItem('aps_projects');if(saved)try{projects=JSON.parse(saved);}catch(e){}});
</script>
</body>
</html>
