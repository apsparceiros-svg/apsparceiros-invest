<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f0f;
  --muted:#9e9e9e;
  --gold:#c9a84b;
  --card:#121212;
  --accent:#e6e6e6;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column}
.project-card .info{flex:1;width:100%}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color: #1e1e1e;
    color: #fff;
    border: 1px solid #c9a84b;
    padding: 6px 8px;
    border-radius: 6px;
    width: 100%;
    margin-bottom:6px;
}
.project-card input[type=text]:focus,
.project-card input[type=number]:focus{
    outline:2px solid #c9a84b;
    background-color:#292929;
}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}

/* Modal styles */
#detailModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-inner {
  width: 92%;
  max-width: 1100px;
  max-height: 92vh;
  background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  border-radius: 12px;
  padding: 14px;
  border:1px solid rgba(255,255,255,0.04);
  overflow:auto;
  position: relative;
}
.modal-close {
  position: absolute;
  right: 12px;
  top: 12px;
  background: transparent;
  border: none;
  color: var(--gold);
  font-size: 20px;
  cursor: pointer;
}
.modal-header { display:flex;justify-content:space-between;align-items:center;margin-bottom:8px }
.modal-tabs { display:flex; gap:8px; margin-bottom:12px; }
.tab-btn {
  background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px;color:var(--accent);cursor:pointer;
}
.tab-btn.active { background:var(--gold); color:#0b0b0b; border-color:var(--gold) }
.modal-charts { display:flex; gap:12px; flex-direction:column }
.canvas-wrap { background:transparent; border-radius:8px; padding:8px; border:1px solid rgba(255,255,255,0.02) }
.stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:8px; margin-top:12px }
.stat { background:var(--card); padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.02) }
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por indicador</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label class="small">Mostrar</label>
        <select id="showIndicators"><option value="all">Todos</option><option value="vgv">VGV</option><option value="irr">TIR</option></select>

        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0">

        <div><strong>Condições de Venda</strong></div>
        <label>Desconto Pré-lançamento (%)</label>
        <input id="discountPre" type="number" min="0" max="100" step="0.1" value="10">
        <label>Desconto Lançamento (%)</label>
        <input id="discountLaunch" type="number" min="0" max="100" step="0.1" value="5">

        <label>Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">

        <label>Parcelas da entrada (nº)</label>
        <input id="entradaMonths" type="number" min="1" step="1" value="6">

        <label>Parcelas do saldo (nº)</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">

        <div class="small" style="margin-top:6px">A entrada é paga em X parcelas a partir do mês da venda; o restante (saldo) é pago em Y parcelas subsequentes.</div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tooltip"><button id="btnHelp" class="button ghost">Legenda</button><div class="tt"><strong>ROI</strong>: retorno sobre o capital investido.<br><strong>TIR</strong>: taxa interna de retorno anualizada.<br><strong>Payback</strong>: meses para recuperar o aporte.</div></div>
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1">
              <div style="height:auto; min-height:120px;">
                <canvas id="chartPortfolio" style="width:100%;height:auto;"></canvas>
              </div>
            </div>
            <div style="width:220px">
              <div class="kpi">
                <div class="item"><div class="small">ROI médio</div><div class="value" id="avgRoi">--</div></div>
                <div class="item"><div class="small">TIR média</div><div class="value" id="avgIrr">--</div></div>
              </div>
              <div style="margin-top:10px" class="small">Clique num projeto no menu lateral para ver detalhes.</div>
            </div>
          </div>
        </div>

        <!-- O detailArea original foi mantido, mas ficará oculto (não usado) -->
        <div id="detailArea" style="display:none"></div>
      </section>

      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table style="width:100%"><tbody>
            <tr><td class="small">VGV</td><td class="small">Valor Geral de Vendas</td></tr>
            <tr><td class="small">ROI</td><td class="small">Retorno sobre o capital</td></tr>
            <tr><td class="small">TIR</td><td class="small">Taxa interna de retorno</td></tr>
            <tr><td class="small">Payback</td><td class="small">Meses para recuperar investimento</td></tr>
          </tbody></table>
        </div>

        <div class="card">
          <div class="section-title">Cap Table (exemplo)</div>
          <div class="small">Incorporador: 50%<br>Terrenista: 20%<br>Investidores: 30%</div>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- ================= Modal de detalhes (mantém tema escuro/dourado) ================= -->
<div id="detailModal">
  <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <button class="modal-close" id="closeModal" title="Fechar">✕</button>
    <div class="modal-header">
      <div>
        <h3 id="modalTitle" style="margin:0;color:var(--gold)"></h3>
        <div class="small" id="modalCity" style="margin-top:4px;color:var(--muted)"></div>
      </div>
      <div style="width:100%;display:flex;justify-content:center;align-items:center;gap:6px">
      <div class="small">VGV</div>
      <div style="font-weight:800;color:var(--gold)" id="modalVgv"></div>
      </div>
    </div>

    <div class="modal-tabs" id="modalTabs">
      <button class="tab-btn active" data-tab="fluxo">Fluxo Líquido</button>
      <button class="tab-btn" data-tab="receitas">Receitas</button>
      <button class="tab-btn" data-tab="custos">Custos</button>
    </div>

    <div class="modal-charts">
      <div class="canvas-wrap" id="wrapFluxo" style="display:block">
        <canvas id="chartFluxo" style="width:100%;height:240px;"></canvas>
      </div>
      <div class="canvas-wrap" id="wrapReceitas" style="display:none">
        <canvas id="chartReceitas" style="width:100%;height:240px;"></canvas>
      </div>
      <div class="canvas-wrap" id="wrapCustos" style="display:none">
        <canvas id="chartCustos" style="width:100%;height:240px;"></canvas>
      </div>

      <div class="stats-grid" id="modalStats" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<script>
// ===== Dados iniciais (mantidos exatamente como antes) =====
let projects = [
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,pre_launch_sales:2,launch_sales:4,monthly_sales:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,pre_launch_sales:1,launch_sales:3,monthly_sales:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,pre_launch_sales:3,launch_sales:5,monthly_sales:4}
];
const PASSWORD="Investidor";
const colors=['#c9a84b','#b58f3a','#d9b86b','#8bc34a','#2196f3','#9c27b0'];

// ===== Persistência das configurações de venda =====
const cfgKey = 'aps_sale_cfg';
let saleCfg = { discountPre:10, discountLaunch:5, parcelasRestantes:24, entradaPct:30, entradaMonths:6 };

function loadCfg(){
  const s = localStorage.getItem(cfgKey);
  if(s) try { saleCfg = Object.assign(saleCfg, JSON.parse(s)); } catch(e){}
  document.getElementById('discountPre').value = saleCfg.discountPre;
  document.getElementById('discountLaunch').value = saleCfg.discountLaunch;
  document.getElementById('parcelasRestantes').value = saleCfg.parcelasRestantes;
  document.getElementById('entradaPct').value = saleCfg.entradaPct;
  document.getElementById('entradaMonths').value = saleCfg.entradaMonths;
}
function saveCfg(){
  saleCfg.discountPre = Number(document.getElementById('discountPre').value) || 0;
  saleCfg.discountLaunch = Number(document.getElementById('discountLaunch').value) || 0;
  saleCfg.parcelasRestantes = Math.max(1, Math.floor(Number(document.getElementById('parcelasRestantes').value) || 24));
  saleCfg.entradaPct = Math.min(100, Math.max(0, Number(document.getElementById('entradaPct').value) || 30));
  saleCfg.entradaMonths = Math.max(1, Math.floor(Number(document.getElementById('entradaMonths').value) || 6));
  localStorage.setItem(cfgKey, JSON.stringify(saleCfg));
  renderSidebar();
}

// ===== Funções financeiras (mantidas) =====
function irr(values, guess = 0.01) {
  const eps = 1e-7;
  const maxIter = 1000;
  let rate = guess;
  const npv = r => values.reduce((s, v, i) => s + v / Math.pow(1 + r, i), 0);
  const dnpv = r => values.reduce((s, v, i) => s - i * v / Math.pow(1 + r, i + 1), 0);
  for (let i = 0; i < maxIter; i++) {
    const f = npv(rate);
    const df = dnpv(rate);
    if (Math.abs(df) < 1e-12) break;
    const nr = rate - f / df;
    if (Math.abs(nr - rate) < eps) return rate;
    rate = nr;
  }
  let low = -0.999, high = 10;
  for (let i = 0; i < 200; i++) {
    const mid = (low + high) / 2;
    const v = npv(mid);
    if (Math.abs(v) < 1e-6) return mid;
    if (v > 0) low = mid; else high = mid;
  }
  return rate;
}

// ===== Novo cálculo de distribuição de vendas com desconto e parcelamento =====
function computeProject(p) {
  // carregar cfg atual
  const cfg = saleCfg;

  const months = p.months;
  const price_unit_full = p.area * p.price_m2;
  const VGV = p.units * price_unit_full;
  const totalConstruction = p.units * p.area * p.cost_m2;

  // vamos construir arrays dinâmicos de recebimentos (podem ultrapassar 'months')
  const receiptsPre = [];   // por mês
  const receiptsLaunch = [];
  const receiptsMonthly = [];
  const investments = [];
  const costs = [];

  // helper: ensure length
  function ensureLen(arr, len){
    while(arr.length < len) arr.push(0);
  }

  // função que adiciona parcelas para uma unidade vendida num determinado mês
  // params: saleMonth (0-index), price_unit (já com desconto quando aplicável), targetArray (receiptsX)
  function addSalePayments(saleMonth, price_unit, targetArray) {
    // entrada configurável (percentual e nº parcelas)
    const entradaPct = (cfg.entradaPct || 30) / 100;
    const entradaMonths = cfg.entradaMonths || 6;

    const entradaTotal = price_unit * entradaPct;
    const entradaParcel = entradaTotal / entradaMonths;

    // restante do saldo
    const restantePct = 1 - entradaPct;
    const restanteTotal = price_unit * restantePct;
    const restParc = cfg.parcelasRestantes || 24;

    // distribuir parcelas da entrada
    for (let m = 0; m < entradaMonths; m++) {
      const idx = saleMonth + m;
      ensureLen(targetArray, idx+1);
      targetArray[idx] += entradaParcel;
    }

    // distribuir parcelas do saldo a partir de saleMonth + entradaMonths
    for (let m = 0; m < restParc; m++) {
      const idx = saleMonth + entradaMonths + m;
      ensureLen(targetArray, idx+1);
      targetArray[idx] += restanteTotal / restParc;
    }
  }

  // distribuir vendas conforme tipo (pré, lançamento, mensais)
  // função genérica para distribuir N unidades começando em startMonth,
  // iterando unidade a unidade (cada unidade "vende" em mês subsequente)
  function distributeUnits(units, startMonth, receiptsArr, type) {
    for (let u = 0; u < units; u++) {
      const saleMonth = startMonth + u;
      // preço unitário com desconto aplicável
      let price_unit = price_unit_full;
      if (type === 'pre' && cfg.discountPre) price_unit = price_unit_full * (1 - cfg.discountPre/100);
      if (type === 'launch' && cfg.discountLaunch) price_unit = price_unit_full * (1 - cfg.discountLaunch/100);
      // monthly sales (pós-lançamento) não recebem desconto aqui
      addSalePayments(saleMonth, price_unit, receiptsArr);
    }
  }

  // distribuir pré-lançamento (começa mês 0)
  distributeUnits(p.pre_launch_sales, 0, receiptsPre, 'pre');
  // distribuir lançamento (começa após pré-lançamento)
  distributeUnits(p.launch_sales, p.pre_launch_sales, receiptsLaunch, 'launch');

  // vendas mensais após lançamento:
  let unitsSoldMonthly = 0;
  let monthIdx = p.pre_launch_sales + p.launch_sales;
  while (unitsSoldMonthly < p.units - (p.pre_launch_sales + p.launch_sales)) {
    const unitsThisMonth = Math.min(p.monthly_sales, p.units - (p.pre_launch_sales + p.launch_sales) - unitsSoldMonthly);
    distributeUnits(unitsThisMonth, monthIdx, receiptsMonthly, 'monthly');
    unitsSoldMonthly += unitsThisMonth;
    monthIdx++;
    // safety to avoid infinite loop
    if (monthIdx > 1000) break;
  }

  // agora unimos arrays e definimos o tamanho final (o maior índice existente)
  const finalLen = Math.max(receiptsPre.length, receiptsLaunch.length, receiptsMonthly.length, months);

  // ===== Investimentos mensais (mantém o modelo anterior até 'months') =====
  const incc = 0.0045;
  const den = (months * (months + 1)) / 2;
  for (let m = 1; m <= finalLen; m++) {
    if (m <= months) {
      const prop = m / den;
      const base = totalConstruction * prop;
      investments[m - 1] = base * Math.pow(1 + incc, m);
    } else {
      investments[m - 1] = 0; // sem investimentos após conclusão
    }
  }

  // ===== Custos mensais (mantemos custos até months; após isso zero) =====
  for (let m = 0; m < finalLen; m++) {
    if (m < months) {
      costs[m] = 0;
      const marketingTotal = 0.015 * VGV;
      const marketingMonthly = marketingTotal / months;
      costs[m] += marketingMonthly;        // marketing proporcional
      costs[m] += 8000 + 3000;             // custos fixos
      if (m === 11) costs[m] += 0.01 * VGV; // custo anual adicional
      if (m === 0) costs[m] += 0.05 * totalConstruction; // entrada de construção
    } else {
      costs[m] = 0;
    }
  }

  // preencher arrays de receipts combinados por mês
  const receipts = [];
  for (let i = 0; i < finalLen; i++) {
    const a = i < receiptsPre.length ? receiptsPre[i] : 0;
    const b = i < receiptsLaunch.length ? receiptsLaunch[i] : 0;
    const c = i < receiptsMonthly.length ? receiptsMonthly[i] : 0;
    receipts[i] = a + b + c;
  }

  // ===== Fluxo líquido =====
  const net = receipts.map((r, i) => r - (investments[i] || 0) - (costs[i] || 0));

  // ===== Indicadores financeiros =====
  const irrMonthly = irr(net);
  const irrAnnual = isFinite(irrMonthly) ? Math.pow(1 + irrMonthly, 12) - 1 : NaN;
  const rate = Math.pow(1 + 0.12, 1 / 12) - 1;
  const npvVal = net.reduce((s, v, i) => s + v / Math.pow(1 + rate, i), 0);

  // Payback (em meses desde o início do fluxo)
  let cumul = 0;
  let payback = '--';
  for (let i = 0; i < net.length; i++) {
    cumul += net[i];
    if (cumul >= 0) { payback = i + 1; break; }
  }

  const totalNet = net.reduce((s, v) => s + v, 0);
  const totalInvestment = investments.reduce((s, v) => s + v, 0);
  const roi = totalInvestment === 0 ? 0 : (totalNet / totalInvestment) * 100;

  // totals for display
  const marketingTotal = 0.015 * VGV;
  const brokerTotal = 0.05 * VGV;

  return {
    receiptsPre,
    receiptsLaunch,
    receiptsMonthly,
    receipts,
    investments,
    costs,
    net,
    irrMonthly,
    irrAnnual,
    npvVal,
    payback,
    roi,
    VGV,
    totalConstruction,
    marketingTotal,
    brokerTotal
  };
}

// ===== Renderização e Gráficos =====
function renderSidebar(){
  const el=document.getElementById('projectsList'); el.innerHTML='';
  const searchVal=document.getElementById('search').value.toLowerCase();
  projects.forEach((p,i)=>{
    if(searchVal && !p.name.toLowerCase().includes(searchVal)) return;
    const d=computeProject(p);
    const div=document.createElement('div'); div.className='project-card';
    const info=document.createElement('div'); info.className='info';
    
    info.innerHTML = `
  <label><strong>Nome</strong></label>
  <input type="text" value="${p.name.replace(/"/g,'&quot;')}" data-field="name">
  <label><strong>Cidade</strong></label>
  <input type="text" value="${p.city.replace(/"/g,'&quot;')}" data-field="city">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
    <div><label>Unidades</label><input type="number" value="${p.units}" data-field="units"></div>
    <div><label>Área (m²)</label><input type="number" value="${p.area}" data-field="area"></div>
    <div><label>Preço/m²</label><input type="number" value="${p.price_m2}" data-field="price_m2"></div>
    <div><label>Custo/m²</label><input type="number" value="${p.cost_m2}" data-field="cost_m2"></div>
    <div><label>Meses</label><input type="number" value="${p.months}" data-field="months"></div>
    <div><label>Pré-lançamento</label><input type="number" value="${p.pre_launch_sales}" data-field="pre_launch_sales"></div>
    <div><label>Lançamento</label><input type="number" value="${p.launch_sales}" data-field="launch_sales"></div>
    <div><label>Vendas/mês</label><input type="number" value="${p.monthly_sales}" data-field="monthly_sales"></div>
  </div>
  <div class="kpi">
    <div class="item"><div class="small">VGV</div><div class="value">${d.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="item"><div class="small">ROI</div><div class="value">${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}</div></div>
    <div class="item"><div class="small">TIR</div><div class="value">${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}</div></div>
  </div>
`;
    info.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const field=inp.dataset.field;
        if(['units','area','price_m2','cost_m2','months','pre_launch_sales','launch_sales','monthly_sales'].includes(field)) p[field]=Number(inp.value);
        else p[field]=inp.value;
        renderSidebar(); if(document.getElementById('detailModal').style.display === 'flex') openProjectModal(p.id);
      });
    });

    div.appendChild(info); div.addEventListener('click',()=>openProjectModal(p.id));
    el.appendChild(div);
  });
  updatePortfolioChart();
}

let portfolioChart=null;
function updatePortfolioChart(){
  const totals=projects.map(p=>computeProject(p).VGV);
  const ctx=document.getElementById('chartPortfolio').getContext('2d');
  if(portfolioChart) {
    // atualizar dados para evitar recriar instância -> melhora performance
    portfolioChart.data.labels = projects.map(p=>p.name);
    portfolioChart.data.datasets[0].data = totals;
    portfolioChart.update();
    document.getElementById('totalVgv').innerText=totals.reduce((s,v)=>s+v,0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
    const avgRoi=projects.reduce((s,p)=> s + computeProject(p).roi,0)/projects.length;
    const avgIrr=projects.reduce((s,p)=> s + computeProject(p).irrAnnual,0)/projects.length;
    document.getElementById('avgRoi').innerText=isFinite(avgRoi)?avgRoi.toFixed(1)+'%':'--';
    document.getElementById('avgIrr').innerText=isFinite(avgIrr)?(avgIrr*100).toFixed(1)+'%':'--';
    return;
  }
  portfolioChart=new Chart(ctx,{type:'doughnut',data:{labels:projects.map(p=>p.name),datasets:[{data:totals,backgroundColor:colors}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#fff'}}}}});
  document.getElementById('totalVgv').innerText=totals.reduce((s,v)=>s+v,0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});
  const avgRoi=projects.reduce((s,p)=> s + computeProject(p).roi,0)/projects.length;
  const avgIrr=projects.reduce((s,p)=> s + computeProject(p).irrAnnual,0)/projects.length;
  document.getElementById('avgRoi').innerText=isFinite(avgRoi)?avgRoi.toFixed(1)+'%':'--';
  document.getElementById('avgIrr').innerText=isFinite(avgIrr)?(avgIrr*100).toFixed(1)+'%':'--';
}

// ===== Modal logic =====
let modalCharts = { fluxo: null, receitas: null, custos: null };
function destroyModalCharts(){
  Object.keys(modalCharts).forEach(k=>{
    if(modalCharts[k]) { try{ modalCharts[k].destroy(); }catch(e){} modalCharts[k]=null; }
  });
}

function openProjectModal(id){
  const p = projects.find(x => x.id === id);
  if(!p) return;
  const d = computeProject(p);

  // preencher header do modal
  document.getElementById('modalTitle').innerText = p.name;
  document.getElementById('modalCity').innerText = p.city;
  document.getElementById('modalVgv').innerText = d.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});

  // preencher estatísticas
  document.getElementById('modalStats').innerHTML = `
    <div class="stat"><div class="small">ROI</div><div style="font-weight:800;color:var(--gold)">${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}</div></div>
    <div class="stat"><div class="small">TIR (a.a.)</div><div style="font-weight:800;color:var(--gold)">${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}</div></div>
    <div class="stat"><div class="small">VPL (12% a.a.)</div><div style="font-weight:800;color:var(--gold)">${d.npvVal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Payback</div><div style="font-weight:800;color:var(--gold)">${d.payback} meses</div></div>
    <div class="stat"><div class="small">Custo construção</div><div style="font-weight:800;color:var(--gold)">${d.totalConstruction.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Marketing</div><div style="font-weight:800;color:var(--gold)">${d.marketingTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Comissão</div><div style="font-weight:800;color:var(--gold)">${d.brokerTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Unidades</div><div style="font-weight:800;color:var(--gold)">${p.units}</div></div>
    <div class="stat"><div class="small">Área total</div><div style="font-weight:800;color:var(--gold)">${(p.units * p.area).toLocaleString('pt-BR')} m²</div></div>
    <div class="stat"><div class="small">Receita média/unidade</div><div style="font-weight:800;color:var(--gold)">${(d.VGV / p.units).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Lucro estimado</div><div style="font-weight:800;color:var(--gold)">${(d.VGV - d.totalConstruction - d.marketingTotal - d.brokerTotal).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
  `;

  // abrir modal
  document.getElementById('detailModal').style.display = 'flex';

  // destruir gráficos antigos
  destroyModalCharts();

  // helper para criar gráfico com tooltip acumulado
  function createModalChart(ctx, datasets){
    return new Chart(ctx,{
      type:'line',
      data:{labels:Array.from({length:d.net.length},(_,i)=>'M'+(i+1)),datasets:datasets},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        interaction:{mode:'nearest', axis:'x', intersect:false},
        scales:{x:{ticks:{color:'#fff'}}, y:{ticks:{color:'#fff'}}},
        plugins:{
          legend:{labels:{color:'#fff'}},
          tooltip:{
            callbacks:{
              label:function(context){
                const v = context.raw || 0;
                const total = context.dataset.data.slice(0, context.dataIndex+1).reduce((s,x)=>s+x,0);
                return context.dataset.label + ': ' + v.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}) 
                       + ' (Total: ' + total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}) + ')';
              }
            }
          }
        }
      }
    });
  }

  // criar gráficos
  modalCharts.fluxo = createModalChart(document.getElementById('chartFluxo').getContext('2d'), [
    {label:'Fluxo Líquido', data:d.net, borderColor:'#c9a84b', backgroundColor:'rgba(201,168,75,0.08)', fill:true, tension:0.3}
  ]);

  modalCharts.receitas = createModalChart(document.getElementById('chartReceitas').getContext('2d'), [
    {label:'Pré-lançamento', data:d.receiptsPre, borderColor:'#ff9800', backgroundColor:'rgba(255,152,0,0.12)', fill:true, tension:0.3},
    {label:'Lançamento', data:d.receiptsLaunch, borderColor:'#4caf50', backgroundColor:'rgba(76,175,80,0.08)', fill:true, tension:0.3},
    {label:'Mensais', data:d.receiptsMonthly, borderColor:'#2196f3', backgroundColor:'rgba(33,150,243,0.06)', fill:true, tension:0.3}
  ]);

  const combinedCosts = d.investments.map((v,i)=>(v||0)+(d.costs[i]||0));
  modalCharts.custos = createModalChart(document.getElementById('chartCustos').getContext('2d'), [
    {label:'Investimentos', data:d.investments, borderColor:'#9c27b0', backgroundColor:'rgba(156,39,176,0.06)', fill:true, tension:0.3},
    {label:'Custos operacionais', data:d.costs, borderColor:'#f44336', backgroundColor:'rgba(244,67,54,0.06)', fill:true, tension:0.3},
    {label:'Total Custos', data:combinedCosts, borderColor:'#ff5722', backgroundColor:'rgba(255,87,34,0.06)', fill:true, tension:0.3}
  ]);

  // aba padrão
  setActiveTab('fluxo');
}

document.getElementById('closeModal').addEventListener('click',()=>{
  document.getElementById('detailModal').style.display='none';
  destroyModalCharts();
});

// gerenciamento de abas no modal
document.querySelectorAll('#modalTabs .tab-btn').forEach(btn=>{
  btn.addEventListener('click', (e) => {
    const tab = btn.dataset.tab;
    setActiveTab(tab);
  });
});
function setActiveTab(tab){
  document.querySelectorAll('#modalTabs .tab-btn').forEach(b=> b.classList.toggle('active', b.dataset.tab===tab));
  document.getElementById('wrapFluxo').style.display = (tab==='fluxo') ? 'block' : 'none';
  document.getElementById('wrapReceitas').style.display = (tab==='receitas') ? 'block' : 'none';
  document.getElementById('wrapCustos').style.display = (tab==='custos') ? 'block' : 'none';
  // se os charts foram criados, chamar update para ajustar tamanhos
  Object.keys(modalCharts).forEach(k=>{ if(modalCharts[k]) try{ modalCharts[k].resize(); modalCharts[k].update(); } catch(e){} });
}

// ===== Persistência e Eventos (mantidos) =====
function saveAll(){ localStorage.setItem('aps_projects',JSON.stringify(projects)); saveCfg(); alert('Alterações salvas no navegador (localStorage).'); }
function exportJson(){const blob=new Blob([JSON.stringify(projects,null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='aps_projects.json';a.click();URL.revokeObjectURL(url);}
function downloadCsv(){const rows=['id,name,city,units,area,price_m2,cost_m2,months,pre_launch_sales,launch_sales,monthly_sales'];projects.forEach(p=>rows.push([p.id,p.name,p.city,p.units,p.area,p.price_m2,p.cost_m2,p.months,p.pre_launch_sales,p.launch_sales,p.monthly_sales].join(',')));const blob=new Blob([rows.join('\n')],{type:'text/csv'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='aps_projects.csv';a.click();URL.revokeObjectURL(url);}

document.getElementById('btnLogin').addEventListener('click',()=>{
  const v=document.getElementById('pwd').value;
  if(v===PASSWORD){
    document.getElementById('loginModal').style.display='none';
    document.getElementById('app').style.display='flex';
    const saved=localStorage.getItem('aps_projects');
    if(saved)try{projects=JSON.parse(saved);}catch(e){}
    loadCfg();
    renderSidebar();
  }else alert('Senha incorreta');
});
document.getElementById('btnExport').addEventListener('click',exportJson);
document.getElementById('btnPublish').addEventListener('click',saveAll);
document.getElementById('btnReset').addEventListener('click',()=>{if(confirm('Restaurar valores iniciais?')){localStorage.removeItem('aps_projects');localStorage.removeItem(cfgKey);location.reload();}});

document.getElementById('btnNew').addEventListener('click',()=>{const id=projects.length+1;projects.push({id:id,name:'Novo Empreendimento '+id,city:'Cidade',units:10,area:70,price_m2:5000,cost_m2:2000,months:18,pre_launch_sales:0,launch_sales:0,monthly_sales:2});renderSidebar();});
document.getElementById('btnDownloadCsv').addEventListener('click',downloadCsv);

// salvar cfg ao alterar inputs
document.getElementById('discountPre').addEventListener('change',saveCfg);
document.getElementById('discountLaunch').addEventListener('change',saveCfg);
document.getElementById('parcelasRestantes').addEventListener('change',saveCfg);
document.getElementById('entradaPct').addEventListener('change',saveCfg);
document.getElementById('entradaMonths').addEventListener('change',saveCfg);

window.addEventListener('load',()=>{
  const saved=localStorage.getItem('aps_projects');
  if(saved)try{projects=JSON.parse(saved);}catch(e){}
  loadCfg();
});
</script>

</body>
</html>
