<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f0f;
  --muted:#9e9e9e;
  --gold:#c9a84b;
  --card:#121212;
  --accent:#e6e6e6;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column}
.project-card .info{flex:1;width:100%}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color: #1e1e1e;
    color: #fff;
    border: 1px solid #c9a84b;
    padding: 6px 8px;
    border-radius: 6px;
    width: 100%;
    margin-bottom:6px;
}
.project-card input[type=text]:focus,
.project-card input[type=number]:focus{
    outline:2px solid #c9a84b;
    background-color:#292929;
}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Configurações de Venda</strong></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label>Percentual de Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="1" value="30">
        <label>Parcelas da Entrada</label>
        <input id="entradaParc" type="number" min="1" step="1" value="6">
        <label>Parcelas Restantes do Saldo</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnDownloadCsv" class="button ghost">Exportar CSV</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
    </div>

    <div class="card">
      <canvas id="chartAll" height="120"></canvas>
    </div>

    <div id="detailArea"></div>

    <div class="card" style="margin-top:12px">
      <h3>Detalhe do Projeto Selecionado</h3>
      <canvas id="chartDetail" height="180"></canvas>
    </div>
  </main>
</div>

<script>
// ===== Dados iniciais =====
let projects=[
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,pre_launch_sales:2,launch_sales:4,monthly_sales:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,pre_launch_sales:1,launch_sales:3,monthly_sales:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,pre_launch_sales:3,launch_sales:5,monthly_sales:4}
];
const PASSWORD="Investidor";
let saleCfg={entradaPct:30,entradaParc:6,parcelasRestantes:24};
let selectedProject=null;

// ===== Persistência =====
function loadCfg(){
  const s=localStorage.getItem('aps_sale_cfg');
  if(s) try{saleCfg=Object.assign(saleCfg,JSON.parse(s));}catch(e){}
  document.getElementById('entradaPct').value=saleCfg.entradaPct;
  document.getElementById('entradaParc').value=saleCfg.entradaParc;
  document.getElementById('parcelasRestantes').value=saleCfg.parcelasRestantes;
}
function saveCfg(){
  saleCfg.entradaPct=Number(document.getElementById('entradaPct').value);
  saleCfg.entradaParc=Number(document.getElementById('entradaParc').value);
  saleCfg.parcelasRestantes=Number(document.getElementById('parcelasRestantes').value);
  localStorage.setItem('aps_sale_cfg',JSON.stringify(saleCfg));
  renderSidebar();
  if(selectedProject!==null) selectProject(selectedProject);
}

// ===== Funções financeiras =====
function irr(values, guess=0.01){
  const eps=1e-7,maxIter=1000; let rate=guess;
  const npv=r=>values.reduce((s,v,i)=>s+v/Math.pow(1+r,i),0);
  const dnpv=r=>values.reduce((s,v,i)=>s-i*v/Math.pow(1+r,i+1),0);
  for(let i=0;i<maxIter;i++){const f=npv(rate),df=dnpv(rate); if(Math.abs(df)<1e-12) break; const nr=rate-f/df; if(Math.abs(nr-rate)<eps) return nr; rate=nr;}
  return rate;
}

// ===== Computa projeto =====
function computeProject(p){
  const cfg=saleCfg;
  const price_unit=p.area*p.price_m2;
  const VGV=price_unit*p.units;
  const totalConstruction=p.area*p.cost_m2*p.units;

  const flow=[];
  let unitsSold=0,month=0;

  // Distribuir pré-lançamento
  for(let i=0;i<p.pre_launch_sales;i++){addSale(month,price_unit*(1-cfg.entradaPct/100),p,flow,month);month++;unitsSold++;}
  for(let i=0;i<p.launch_sales;i++){addSale(month,price_unit*(1-cfg.entradaPct/100),p,flow,month);month++;unitsSold++;}
  while(unitsSold<p.units){
    const mSales=Math.min(p.monthly_sales,p.units-unitsSold);
    for(let j=0;j<mSales;j++){addSale(month,price_unit,p,flow,month);}
    month++; unitsSold+=mSales;
  }

  // Investimento e custos
  const investments=[]; const costs=[]; const net=[];
  for(let m=0;m<flow.length;m++){
    const invest=m< p.months?totalConstruction/p.months:0;
    investments[m]=invest; costs[m]=0;
    net[m]=flow[m].receita - invest - costs[m];
  }

  // Cálculos acumulados
  const cumFlow=[];
  net.reduce((a,v,i)=>cumFlow[i]=a+v,a=0);

  // Indicadores
  const irrMonthly=irr(net); const roi=(net.reduce((a,v)=>a+v,0)/investments.reduce((a,v)=>a+v,0))*100||0;
  const tir=irrMonthly*12*100;
  let payback='--',c=0; for(let v of net){c+=v;if(c>=0){payback=c; break;}}

  return {flow, cumFlow, roi, tir, payback, VGV, totalConstruction};
}

// ===== Distribui venda =====
function addSale(month,price_unit,p,flow,idx){
  const cfg=saleCfg;
  for(let i=0;i<cfg.entradaParc;i++){
    ensure(flow,month+i); flow[month+i]=flow[month+i]||{month:month+i+1,receita:0,invest:0,net:0}; flow[month+i].receita+=price_unit*cfg.entradaPct/100/cfg.entradaParc;
  }
  for(let i=0;i<cfg.parcelasRestantes;i++){
    ensure(flow,month+cfg.entradaParc+i); flow[month+cfg.entradaParc+i]=flow[month+cfg.entradaParc+i]||{month:month+cfg.entradaParc+i+1,receita:0,invest:0,net:0};
    flow[month+cfg.entradaParc+i].receita+=price_unit*(1-cfg.entradaPct/100)/cfg.parcelasRestantes;
  }
}
function ensure(arr,i){while(arr.length<=i) arr.push(undefined);}

// ===== Renderização Sidebar =====
function renderSidebar(){
  const el=document.getElementById('projectsList'); el.innerHTML='';
  const search=document.getElementById('search').value.toLowerCase();
  projects.forEach((p,i)=>{
    if(search && !p.name.toLowerCase().includes(search)) return;
    const comp=computeProject(p);
    const div=document.createElement('div'); div.className='project-card';
    const info=document.createElement('div'); info.className='info';
    info.innerHTML=`
      <label>Nome</label><input type="text" value="${p.name}" data-field="name">
      <label>Cidade</label><input type="text" value="${p.city}" data-field="city">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
        <div><label>Unidades</label><input type="number" value="${p.units}" data-field="units"></div>
        <div><label>Área</label><input type="number" value="${p.area}" data-field="area"></div>
        <div><label>Preço/m²</label><input type="number" value="${p.price_m2}" data-field="price_m2"></div>
        <div><label>Custo/m²</label><input type="number" value="${p.cost_m2}" data-field="cost_m2"></div>
        <div><label>Meses</label><input type="number" value="${p.months}" data-field="months"></div>
        <div><label>Pré-lançamento</label><input type="number" value="${p.pre_launch_sales}" data-field="pre_launch_sales"></div>
        <div><label>Lançamento</label><input type="number" value="${p.launch_sales}" data-field="launch_sales"></div>
        <div><label>Vendas/mês</label><input type="number" value="${p.monthly_sales}" data-field="monthly_sales"></div>
      </div>
      <div class="kpi">
        <div class="item"><div class="small">VGV</div><div class="value">R$ ${comp.VGV.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div></div>
        <div class="item"><div class="small">ROI</div><div class="value">${comp.roi.toFixed(1)}%</div></div>
        <div class="item"><div class="small">TIR</div><div class="value">${comp.tir.toFixed(1)}%</div></div>
      </div>`;
    info.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('input',()=>{
        const field=inp.dataset.field;
        p[field]=['units','area','price_m2','cost_m2','months','pre_launch_sales','launch_sales','monthly_sales'].includes(field)?Number(inp.value):inp.value;
        renderSidebar();
        if(selectedProject!==null) selectProject(selectedProject);
      });
    });
    div.appendChild(info); div.addEventListener('click',()=>{selectedProject=i; selectProject(i);});
    el.appendChild(div);
  });
  renderAllChart();
}

// ===== Chart Portfólio =====
let chartAll=null;
function renderAllChart(){
  const ctx=document.getElementById('chartAll').getContext('2d');
  if(chartAll) chartAll.destroy();
  chartAll=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:projects.map(p=>p.name),
      datasets:[{data:projects.map(p=>computeProject(p).VGV),backgroundColor:['#c9a84b','#4caf50','#2196f3']}]
    },
    options:{responsive:true,plugins:{legend:{position:'bottom'}}}
  });
}

// ===== Chart Detalhado =====
let chartDetail=null;
function renderProjectChart(index){
  if(index===null) return;
  const p=projects[index];
  const comp=computeProject(p);
  const labels=comp.flow.map(f=>f.month);
  const dataReceita=comp.flow.map(f=>f.receita);
  const dataInvest=comp.flow.map(f=>f.invest);
  const dataNet=comp.flow.map(f=>f.net);
  const dataAcum=comp.cumFlow;

  const ctx=document.getElementById('chartDetail').getContext('2d');
  if(chartDetail) chartDetail.destroy();
  chartDetail=new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[
        {label:'Receita', data:dataReceita, borderColor:'#4caf50', backgroundColor:'#4caf5033', tension:0.3},
        {label:'Investimento', data:dataInvest, borderColor:'#f44336', backgroundColor:'#f4433633', tension:0.3},
        {label:'Fluxo Líquido', data:dataNet, borderColor:'#2196f3', backgroundColor:'#2196f333', tension:0.3},
        {label:'Acumulado', data:dataAcum, borderColor:'#c9a84b', backgroundColor:'#c9a84b33', tension:0.3}
      ]
    },
    options:{
      responsive:true,
      plugins:{legend:{position:'bottom'}},
      scales:{y:{beginAtZero:true,title:{display:true,text:'R$'}},x:{title:{display:true,text:'Mês'}}}
    }
  });
}

// ===== Selecionar Projeto =====
function selectProject(i){
  selectedProject=i;
  const p=projects[i]; const comp=computeProject(p);
  const dArea=document.getElementById('detailArea');
  dArea.innerHTML=`<div class="card">
    <strong>${p.name} — ${p.city}</strong>
    <table style="width:100%;border-collapse:collapse;margin-top:6px">
      <thead><tr><th>Mês</th><th>Receita</th><th>Investimento</th><th>Fluxo Líquido</th><th>Acumulado</th></tr></thead>
      <tbody>${comp.flow.map(f=>`<tr>
        <td>${f.month}</td>
        <td>R$ ${f.receita.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
        <td>R$ ${f.invest.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
        <td>R$ ${f.net.toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
        <td>R$ ${comp.cumFlow[f.month-1].toLocaleString('pt-BR',{minimumFractionDigits:2})}</td>
      </tr>`).join('')}</tbody>
    </table>
  </div>`;
  renderProjectChart(i);
}

// ===== Eventos =====
document.getElementById('btnLogin').addEventListener('click',()=>{
  const val=document.getElementById('pwd').value;
  if(val===PASSWORD){document.getElementById('loginModal').style.display='none';document.getElementById('app').style.display='flex';loadCfg();renderSidebar();}
  else alert('Senha incorreta!');
});
document.getElementById('search').addEventListener('input',renderSidebar);
document.getElementById('entradaPct').addEventListener('input',saveCfg);
document.getElementById('entradaParc').addEventListener('input',saveCfg);
document.getElementById('parcelasRestantes').addEventListener('input',saveCfg);

document.getElementById('btnNew').addEventListener('click',()=>{
  const newProj={id:Date.now(),name:"Novo Projeto",city:"Cidade",units:10,area:50,price_m2:5000,cost_m2:2500,months:12,pre_launch_sales:1,launch_sales:1,monthly_sales:2};
  projects.push(newProj); renderSidebar();
});
document.getElementById('btnExport').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(projects,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projects.json'; a.click();
});
document.getElementById('btnDownloadCsv').addEventListener('click',()=>{
  let csv="id,name,city,units,area,price_m2,cost_m2,months,pre_launch_sales,launch_sales,monthly_sales\n";
  projects.forEach(p=>{csv+=`${p.id},"${p.name}","${p.city}",${p.units},${p.area},${p.price_m2},${p.cost_m2},${p.months},${p.pre_launch_sales},${p.launch_sales},${p.monthly_sales}\n`});
  const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='projects.csv'; a.click();
});
</script>
</body>
</html>
