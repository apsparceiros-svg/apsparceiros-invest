<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f0f;
  --muted:#9e9e9e;
  --gold:#c9a84b;
  --card:#121212;
  --accent:#e6e6e6;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:340px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column}
.project-card .info{flex:1;width:100%}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color: #1e1e1e;
    color: #fff;
    border: 1px solid #c9a84b;
    padding: 6px 8px;
    border-radius: 6px;
    width: 100%;
    margin-bottom:6px;
}
.project-card input[type=text]:focus,
.project-card input[type=number]:focus{
    outline:2px solid #c9a84b;
    background-color:#292929;
}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}

/* Modal */
#projectModal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:60;overflow:auto;padding:20px}
#projectModal > div{background:#0b0b0b;border-radius:12px;padding:20px;position:relative;max-width:900px;width:100%;color:var(--accent)}
#projectModal .modal-close{position:absolute;top:20px;right:20px;background:transparent;border:none;color:var(--accent);font-size:20px;cursor:pointer}
#projectModal .modal-totals{display:flex;gap:16px;margin-bottom:8px;flex-wrap:wrap}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <!-- Sidebar (mantido original) -->
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Filtrar</strong><div class="small">por indicador</div></div>
        <div><button id="btnNew" class="button">+ Novo</button></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Busca</label><input id="search" type="text" placeholder="Pesquisar projeto...">
        <label class="small">Mostrar</label>
        <select id="showIndicators"><option value="all">Todos</option><option value="vgv">VGV</option><option value="irr">TIR</option></select>
        <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:10px 0">
        <div><strong>Condições de Venda</strong></div>
        <label>Desconto Pré-lançamento (%)</label>
        <input id="discountPre" type="number" min="0" max="100" step="0.1" value="10">
        <label>Desconto Lançamento (%)</label>
        <input id="discountLaunch" type="number" min="0" max="100" step="0.1" value="5">
        <label>Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">
        <label>Parcelas da entrada (nº)</label>
        <input id="entradaMonths" type="number" min="1" step="1" value="6">
        <label>Parcelas do saldo (nº)</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">
        <div class="small" style="margin-top:6px">A entrada é paga em X parcelas a partir do mês da venda; o restante (saldo) é pago em Y parcelas subsequentes.</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tooltip"><button id="btnHelp" class="button ghost">Legenda</button><div class="tt"><strong>ROI</strong>: retorno sobre o capital investido.<br><strong>TIR</strong>: taxa interna de retorno anualizada.<br><strong>Payback</strong>: meses para recuperar o aporte.</div></div>
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1"><canvas id="chartPortfolio" height="120"></canvas></div>
            <div style="width:220px">
              <div class="kpi">
                <div class="item"><div class="small">ROI médio</div><div class="value" id="avgRoi">--</div></div>
                <div class="item"><div class="small">TIR média</div><div class="value" id="avgIrr">--</div></div>
              </div>
              <div style="margin-top:10px" class="small">Clique num projeto no menu lateral para ver detalhes.</div>
            </div>
          </div>
        </div>
      </section>
      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table style="width:100%"><tbody>
            <tr><td class="small">VGV</td><td class="small" id="sumVgv">--</td></tr>
            <tr><td class="small">ROI médio</td><td class="small" id="sumRoi">--</td></tr>
            <tr><td class="small">TIR média</td><td class="small" id="sumIrr">--</td></tr>
          </tbody></table>
        </div>
      </aside>
    </div>
  </main>
</div>

<!-- Modal do Projeto -->
<div id="projectModal">
  <div>
    <button class="modal-close" onclick="closeProjectModal()">✕</button>
    <div class="modal-header">
      <div>
        <h3 id="modalTitle" style="margin:0;color:var(--gold)"></h3>
        <div class="small" id="modalCity"></div>
        <div class="small" id="modalVGV" style="margin-top:4px;font-weight:800;color:var(--gold)"></div>
      </div>
    </div>
    <div class="modal-totals" id="modalTotals"></div>
    <div class="modal-charts" style="margin-top:12px">
      <canvas id="modalChart" style="width:100%;height:auto"></canvas>
    </div>
    <div class="stats-grid" id="modalStats" style="margin-top:16px;display:grid;grid-template-columns:1fr;gap:12px"></div>
  </div>
</div>

<script>
let projects = []; // Aqui você popula com seus projetos
let modalChart;

// Plugin para mostrar totais no topo
const totalsPlugin = {
  id: 'totalsPlugin',
  afterDatasetsDraw(chart) {
    const {ctx, data, chartArea: {top, left}} = chart;
    ctx.save();
    ctx.fillStyle = '#c9a84b';
    ctx.font = 'bold 13px Inter';
    ctx.textAlign = 'left';
    data.datasets.forEach((dataset, i) => {
      const total = dataset.data.reduce((s, v) => s + v, 0);
      ctx.fillText(`${dataset.label} total: ${total.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}`, left + 10, top + 15 + i*18);
    });
    ctx.restore();
  }
};

// Função que abre modal (mantendo todos os cálculos existentes)
function openProjectModal(id){
  const p = projects.find(x => x.id===id);
  const d = computeProject(p); // sua função de cálculo existente

  document.getElementById('projectModal').style.display = 'flex';
  document.getElementById('modalTitle').innerText = p.name;
  document.getElementById('modalCity').innerText = p.city;
  document.getElementById('modalVGV').innerText = 'VGV: '+d.VGV.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0});

  // Totais
  const totalPre = d.receiptsPre.reduce((s,v)=>s+v,0);
  const totalLaunch = d.receiptsLaunch.reduce((s,v)=>s+v,0);
  const totalMensais = d.receiptsMonthly.reduce((s,v)=>s+v,0);
  const totalFluxo = d.net.reduce((s,v)=>s+v,0);

  document.getElementById('modalTotals').innerHTML = `
    <div class="stat"><div class="small">Fluxo Líquido total</div><div style="font-weight:800;color:var(--gold)">${totalFluxo.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}</div></div>
    <div class="stat"><div class="small">Receitas totais</div>
      <div style="font-weight:800;color:var(--gold)">
        Pré-lançamento: ${totalPre.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})} | 
        Lançamento: ${totalLaunch.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})} | 
        Mensais: ${totalMensais.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}
      </div>
    </div>
  `;

  // Estatísticas detalhadas
  document.getElementById('modalStats').innerHTML = `
    <div class="card">
      <div class="small">Resumo</div>
      <div style="margin-top:8px">
        <strong>ROI:</strong> ${isFinite(d.roi)?d.roi.toFixed(1)+'%':'--'}<br>
        <strong>TIR (a.a.):</strong> ${isFinite(d.irrAnnual)?(d.irrAnnual*100).toFixed(1)+'%':'--'}<br>
        <strong>VPL (12% a.a.):</strong> ${d.npvVal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}<br>
        <strong>Payback:</strong> ${d.payback} meses
      </div>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="small">Custos</div>
      <div style="margin-top:8px">
        Custo construção: ${d.totalConstruction.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}<br>
        Marketing: ${d.marketingTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}<br>
        Comissão: ${d.brokerTotal.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}
      </div>
    </div>
  `;

  // Criar gráfico
  const ctx = document.getElementById('modalChart').getContext('2d');
  if(modalChart) modalChart.destroy();
  modalChart = new Chart(ctx,{
    type:'line',
    data:{
      labels:Array.from({length:d.net.length},(_,i)=>'M'+(i+1)),
      datasets:[
        {label:'Pré-lançamento', data:d.receiptsPre, borderColor:'#ff9800', backgroundColor:'rgba(255,152,0,0.2)', fill:true, tension:0.3},
        {label:'Lançamento', data:d.receiptsLaunch, borderColor:'#4caf50', backgroundColor:'rgba(76,175,80,0.2)', fill:true, tension:0.3},
        {label:'Vendas Mensais', data:d.receiptsMonthly, borderColor:'#2196f3', backgroundColor:'rgba(33,150,243,0.2)', fill:true, tension:0.3},
        {label:'Fluxo Líquido', data:d.net, borderColor:'#c9a84b', backgroundColor:'rgba(201,168,75,0.08)', fill:true, tension:0.3}
      ]
    },
    options:{
      plugins:{
        legend:{labels:{color:'#fff'}},
        tooltip:{mode:'index', intersect:false, callbacks:{
          label:function(context){return context.dataset.label+': '+(context.raw||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0})}
        }}
      },
      interaction:{mode:'nearest', axis:'x', intersect:false},
      scales:{x:{ticks:{color:'#fff'}},y:{ticks:{color:'#fff'}}}
    },
    plugins:[totalsPlugin]
  });
}

// Fechar modal
function closeProjectModal(){document.getElementById('projectModal').style.display='none'}

// Exemplo de função que antes renderizava no #detailArea
function selectProject(id){ openProjectModal(id); }

// Login (exemplo)
document.getElementById('btnLogin').onclick = () => {
  if(document.getElementById('pwd').value==='Investidor'){
    document.getElementById('loginModal').style.display='none';
    document.getElementById('app').style.display='flex';
  } else alert('Senha incorreta');
}
</script>
</body>
</html>
