<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>APSPARCEIROS Invest — Dashboard Premium</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{
  --bg:#070707;
  --panel:#0f0f0f;
  --muted:#9e9e9e;
  --gold:#c9a84b;
  --card:#121212;
  --accent:#e6e6e6;
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial;color:var(--accent)}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#040404,#0a0a0a);-webkit-font-smoothing:antialiased}
.header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;border-bottom:1px solid rgba(255,255,255,0.04)}
.brand{font-weight:800;color:var(--gold);letter-spacing:0.6px}
.header .meta{color:var(--muted);font-size:13px}
.container{display:flex;height:calc(100vh - 72px);gap:18px;padding:18px}
.sidebar{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:14px;overflow:auto}
.content{flex:1;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border-radius:12px;padding:14px;overflow:auto}
.section-title{font-weight:700;color:var(--gold);margin-bottom:8px}
.project-card{background:var(--card);padding:12px;border-radius:10px;margin-bottom:12px;display:flex;gap:12px;align-items:flex-start;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column}
.project-card .info{flex:1;width:100%}
.small{font-size:12px;color:var(--muted)}
.kpi{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.kpi .item{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:8px;border-radius:8px;min-width:90px;text-align:center}
.kpi .value{font-weight:700;color:var(--gold);margin-top:6px}
.controls label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
.controls input[type=text],
.controls input[type=number],
.project-card input[type=text],
.project-card input[type=number]{
    background-color: #1e1e1e;
    color: #fff;
    border: 1px solid #c9a84b;
    padding: 6px 8px;
    border-radius: 6px;
    width: 100%;
    margin-bottom:6px;
}
.project-card input[type=text]:focus,
.project-card input[type=number]:focus{
    outline:2px solid #c9a84b;
    background-color:#292929;
}
.button{background:var(--gold);color:#0b0b0b;border:none;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:700}
.button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--accent)}
.card{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:12px;border:1px solid rgba(255,255,255,0.02)}
.tooltip{position:relative;display:inline-block}
.tooltip .tt{visibility:hidden;width:260px;background:#0c0c0c;color:var(--muted);text-align:left;border-radius:6px;padding:10px;position:absolute;z-index:10;bottom:130%;left:50%;transform:translateX(-50%);opacity:0;transition:opacity .12s}
.tooltip:hover .tt{visibility:visible;opacity:1}
@media(max-width:980px){.container{flex-direction:column}.sidebar{width:auto}}
</style>
</head>
<body>

<header class="header">
  <div class="brand">APSPARCEIROS Invest</div>
  <div class="meta">Dashboard · Portfólio · Proteção</div>
</header>

<!-- Login Modal -->
<div id="loginModal" style="position:fixed;inset:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:50">
  <div style="background:#0b0b0b;padding:22px;border-radius:10px;width:420px;border:1px solid rgba(255,255,255,0.04)">
    <h3 style="margin-top:0;color:var(--gold)">Acesso ao Painel</h3>
    <p class="small" style="margin-bottom:12px">Insira a senha para editar os valores</p>
    <input id="pwd" type="password" placeholder="Senha" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--accent)">
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="btnLogin" class="button">Entrar</button>
    </div>
    <p class="small" style="margin-top:10px;color:var(--muted)">Senha: <strong>Investidor</strong></p>
  </div>
</div>

<div class="container" id="app" style="display:none">
  <aside class="sidebar">
    <div class="section-title">Portfólio</div>
    <div id="projectsList"></div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Condições de Venda</strong></div>
      </div>
      <div class="controls" style="margin-top:10px">
        <label>Desconto Pré-lançamento (%)</label>
        <input id="discountPre" type="number" min="0" max="100" step="0.1" value="10">
        <label>Desconto Lançamento (%)</label>
        <input id="discountLaunch" type="number" min="0" max="100" step="0.1" value="5">
        <label>Entrada (%)</label>
        <input id="entradaPct" type="number" min="0" max="100" step="0.1" value="30">
        <label>Parcelas da Entrada</label>
        <input id="entradaParc" type="number" min="1" step="1" value="6">
        <label>Parcelas do saldo (nº)</label>
        <input id="parcelasRestantes" type="number" min="1" step="1" value="24">

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="btnExport" class="button">Exportar JSON</button>
          <button id="btnReset" class="button ghost">Restaurar</button>
        </div>
      </div>
    </div>
    <div class="footer small">APSPARCEIROS Invest · Template editável</div>
  </aside>

  <main class="content">
    <div style="display:flex;gap:12px;align-items:center">
      <div style="flex:1">
        <h2 id="panelTitle">Dashboard</h2>
        <div class="small">Edite os projetos e clique em salvar</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="tooltip"><button id="btnHelp" class="button ghost">Legenda</button>
          <div class="tt">
            <strong>ROI</strong>: retorno sobre o capital investido.<br>
            <strong>TIR</strong>: taxa interna de retorno anualizada.<br>
            <strong>Payback</strong>: meses para recuperar o aporte.
          </div>
        </div>
        <button id="btnDownloadCsv" class="button ghost">Download CSV</button>
        <button id="btnPublish" class="button">Salvar alterações</button>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 360px;gap:18px;margin-top:12px">
      <section>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Visão Geral do Portfólio</strong><div class="small">Resumo consolidado</div></div>
            <div style="text-align:right">
              <div class="small">VGV total</div>
              <div style="font-weight:800;color:var(--gold)" id="totalVgv">R$ 0</div>
            </div>
          </div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1"><canvas id="chartPortfolio" height="120"></canvas></div>
            <div style="width:220px">
              <div class="kpi">
                <div class="item"><div class="small">ROI médio</div><div class="value" id="avgRoi">--</div></div>
                <div class="item"><div class="small">TIR média</div><div class="value" id="avgIrr">--</div></div>
              </div>
              <div style="margin-top:10px" class="small">Clique num projeto no menu lateral para ver detalhes.</div>
            </div>
          </div>
        </div>

        <div id="detailArea"></div>
      </section>

      <aside>
        <div class="card">
          <div class="section-title">Indicadores rápidos</div>
          <table style="width:100%"><tbody>
            <tr><td class="small">VGV</td><td class="small">Valor Geral de Vendas</td></tr>
            <tr><td class="small">ROI</td><td class="small">Retorno sobre o capital</td></tr>
            <tr><td class="small">TIR</td><td class="small">Taxa interna de retorno</td></tr>
            <tr><td class="small">Payback</td><td class="small">Meses para recuperar investimento</td></tr>
          </tbody></table>
        </div>
      </aside>
    </div>
  </main>
</div>

<script>
// ===== Dados iniciais =====
let projects = [
  {id:1,name:"Residencial Ubatuba Premium",city:"Ubatuba - SP",units:30,area:80,price_m2:7000,cost_m2:2800,months:24,pre_launch_sales:2,launch_sales:4,monthly_sales:3},
  {id:2,name:"Residencial Caraguá Vista",city:"Caraguá - SP",units:24,area:75,price_m2:6500,cost_m2:2600,months:22,pre_launch_sales:1,launch_sales:3,monthly_sales:3},
  {id:3,name:"Residencial Guarujá Prime",city:"Guarujá - SP",units:36,area:90,price_m2:7200,cost_m2:3000,months:28,pre_launch_sales:3,launch_sales:5,monthly_sales:4}
];

const PASSWORD="Investidor";
const colors=['#c9a84b','#b58f3a','#d9b86b','#8bc34a','#2196f3','#9c27b0'];

// ===== Configurações de Venda =====
let saleCfg = { discountPre:10, discountLaunch:5, entradaPct:30, entradaParc:6, parcelasRestantes:24 };

function loadCfg(){
  const s = localStorage.getItem('aps_sale_cfg');
  if(s) try { saleCfg = Object.assign(saleCfg, JSON.parse(s)); } catch(e){}
  document.getElementById('discountPre').value = saleCfg.discountPre;
  document.getElementById('discountLaunch').value = saleCfg.discountLaunch;
  document.getElementById('entradaPct').value = saleCfg.entradaPct;
  document.getElementById('entradaParc').value = saleCfg.entradaParc;
  document.getElementById('parcelasRestantes').value = saleCfg.parcelasRestantes;
}

function saveCfg(){
  saleCfg.discountPre = Number(document.getElementById('discountPre').value) || 0;
  saleCfg.discountLaunch = Number(document.getElementById('discountLaunch').value) || 0;
  saleCfg.entradaPct = Number(document.getElementById('entradaPct').value) || 0;
  saleCfg.entradaParc = Math.max(1, Math.floor(Number(document.getElementById('entradaParc').value) || 1));
  saleCfg.parcelasRestantes = Math.max(1, Math.floor(Number(document.getElementById('parcelasRestantes').value) || 24));
  localStorage.setItem('aps_sale_cfg', JSON.stringify(saleCfg));
  renderSidebar();
}

// ===== Funções financeiras =====
function irr(values, guess = 0.01) {
  const eps = 1e-7, maxIter = 1000; let rate = guess;
  const npv = r => values.reduce((s,v,i)=>s+v/Math.pow(1+r,i),0);
  const dnpv = r => values.reduce((s,v,i)=>s - i*v/Math.pow(1+r,i+1),0);
  for(let i=0;i<maxIter;i++){ const f=npv(rate); const df=dnpv(rate); if(Math.abs(df)<1e-12) break; const nr=rate-f/df; if(Math.abs(nr-rate)<eps) return nr; rate=nr;}
  return rate;
}

// ===== Cálculo do projeto =====
function computeProject(p){
  const cfg = saleCfg;
  const months = p.months;
  const price_unit_full = p.area * p.price_m2;
  const VGV = p.units * price_unit_full;
  const totalConstruction = p.units * p.area * p.cost_m2;

  const receiptsPre=[], receiptsLaunch=[], receiptsMonthly=[], investments=[], costs=[];

  function ensureLen(arr,len){while(arr.length<len) arr.push(0);}
  function addSalePayments(saleMonth, price_unit, targetArray){
    const entradaTotal = price_unit * cfg.entradaPct/100;
    const entradaParcel = entradaTotal / cfg.entradaParc;
    const restanteTotal = price_unit - entradaTotal;
    for(let m=0;m<cfg.entradaParc;m++){ensureLen(targetArray,saleMonth+m+1); targetArray[saleMonth+m]+=entradaParcel;}
    for(let m=0;m<cfg.parcelasRestantes;m++){ensureLen(targetArray,saleMonth+cfg.entradaParc+m+1); targetArray[saleMonth+cfg.entradaParc+m]+=restanteTotal/cfg.parcelasRestantes;}
  }

  function distributeUnits(units,startMonth,receiptsArr,type){
    for(let u=0;u<units;u++){
      const saleMonth = startMonth+u;
      let price_unit = price_unit_full;
      if(type==='pre') price_unit*=1-cfg.discountPre/100;
      if(type==='launch') price_unit*=1-cfg.discountLaunch/100;
      addSalePayments(saleMonth,price_unit,receiptsArr);
    }
  }

  distributeUnits(p.pre_launch_sales,0,receiptsPre,'pre');
  distributeUnits(p.launch_sales,p.pre_launch_sales,receiptsLaunch,'launch');

  let unitsSoldMonthly = 0; let monthIdx = p.pre_launch_sales+p.launch_sales;
  while(unitsSoldMonthly < p.units-(p.pre_launch_sales+p.launch_sales)){
    const unitsThisMonth = Math.min(p.monthly_sales,p.units-(p.pre_launch_sales+p.launch_sales)-unitsSoldMonthly);
    distributeUnits(unitsThisMonth,monthIdx,receiptsMonthly,'monthly');
    unitsSoldMonthly+=unitsThisMonth;
    monthIdx++;
    if(monthIdx>1000) break;
  }

  const finalLen = Math.max(receiptsPre.length, receiptsLaunch.length, receiptsMonthly.length, months);

  const incc = 0.0045; const den=(months*(months+1))/2;
  for(let m=1;m<=finalLen;m++){if(m<=months) investments[m-1]=totalConstruction*m/den*Math.pow(1+incc,m); else investments[m-1]=0;}
  for(let m=0;m<finalLen;m++){costs[m]=0; if(m<months){costs[m]+=0.015*VGV; costs[m]+=8000+3000; if(m===11) costs[m]+=0.01*VGV; if(m===0) costs[m]+=0.05*totalConstruction;}}

  const receipts=[]; for(let i=0;i<finalLen;i++){receipts[i]=(receiptsPre[i]||0)+(receiptsLaunch[i]||0)+(receiptsMonthly[i]||0);}

  const fluxo=[]; let acum=0; for(let i=0;i<finalLen;i++){fluxo[i]=receipts[i]-investments[i]-costs[i]; acum+=fluxo[i]; fluxo[i]=acum;}

  const roi = ((receipts.reduce((a,b)=>a+b,0)-investments.reduce((a,b)=>a+b,0))/investments.reduce((a,b)=>a+b,0))*100;
  const irr_val = irr(receipts.map((v,i)=>-investments[i]+v))*100;
  const paybackMonth = fluxo.findIndex(f=>f>0)+1;

  return {VGV,ROI:roi,TIR:irr_val.toFixed(2),Payback:paybackMonth,fluxo,receipts,investments,costs,finalLen};
}

// ===== Renderização =====
function renderSidebar(){
  const container = document.getElementById('projectsList');
  container.innerHTML='';
  projects.forEach((p,i)=>{
    const card = document.createElement('div');
    card.className='project-card';
    card.innerHTML=`
      <div class="info"><strong>${p.name}</strong><div class="small">${p.city}</div></div>
    `;
    card.onclick=()=>renderDetail(p);
    container.appendChild(card);
  });
}

let chartPortfolio=null;
function renderPortfolioChart(){
  const ctx=document.getElementById('chartPortfolio').getContext('2d');
  const datasets=projects.map((p,i)=>{
    const cp=computeProject(p);
    return {label:p.name,data:cp.fluxo,backgroundColor:colors[i%colors.length],borderColor:colors[i%colors.length]};
  });
  if(chartPortfolio) chartPortfolio.destroy();
  chartPortfolio=new Chart(ctx,{type:'line',data:{labels:Array.from({length:100},(_,i)=>i+1),datasets:datasets},options:{responsive:true,plugins:{legend:{display:true}}}});
}

// ===== Detalhe do projeto =====
function renderDetail(p){
  const area = document.getElementById('detailArea');
  const cp = computeProject(p);
  area.innerHTML=`
    <div class="card">
      <strong>${p.name}</strong> — ${p.city}<br>
      <div class="kpi">
        <div class="item"><div class="small">VGV</div><div class="value">R$ ${cp.VGV.toLocaleString()}</div></div>
        <div class="item"><div class="small">ROI</div><div class="value">${cp.ROI.toFixed(2)}%</div></div>
        <div class="item"><div class="small">TIR</div><div class="value">${cp.TIR}%</div></div>
        <div class="item"><div class="small">Payback</div><div class="value">${cp.Payback} meses</div></div>
      </div>
      <div style="margin-top:12px">
        <canvas id="chartDetail${p.id}" height="160"></canvas>
      </div>
    </div>
  `;
  const ctx = document.getElementById(`chartDetail${p.id}`).getContext('2d');
  new Chart(ctx,{type:'line',data:{labels:Array.from({length:cp.finalLen},(_,i)=>i+1),datasets:[
    {label:'Fluxo Acumulado',data:cp.fluxo,borderColor:colors[0],backgroundColor:'rgba(201,168,75,0.2)'}
  ]},options:{responsive:true,plugins:{legend:{display:true}}}});
}

// ===== Eventos =====
document.getElementById('btnLogin').onclick=()=>{
  if(document.getElementById('pwd').value===PASSWORD){
    document.getElementById('loginModal').style.display='none';
    document.getElementById('app').style.display='flex';
    renderSidebar();
    renderPortfolioChart();
  } else alert('Senha incorreta');
};

document.getElementById('btnPublish').onclick=()=>{
  saveCfg();
  alert('Alterações salvas no navegador');
};

document.getElementById('btnReset').onclick=()=>{
  localStorage.removeItem('aps_sale_cfg');
  loadCfg();
  renderSidebar();
  renderPortfolioChart();
};

document.getElementById('btnExport').onclick=()=>{
  saveCfg();
  const data = {projects,saleCfg};
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='aps_portfolio.json'; a.click();
};

document.getElementById('btnDownloadCsv').onclick=()=>{
  const rows = [['Projeto','Mês','Receita','Investimento','Fluxo Líquido Acumulado']];
  projects.forEach(p=>{
    const cp = computeProject(p);
    for(let i=0;i<cp.finalLen;i++){
      rows.push([p.name,i+1,cp.receipts[i].toFixed(2),cp.investments[i].toFixed(2),cp.fluxo[i].toFixed(2)]);
    }
  });
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='aps_portfolio.csv'; a.click();
};

// ===== Inicialização =====
loadCfg();
</script>
</body>
</html>
