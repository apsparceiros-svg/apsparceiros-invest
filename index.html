<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Simulador de Vendas - Arquivo Consolidado</title>
<style>
  body {
    margin: 0;
    background: #0b0b0b;
    color: #fff;
    font-family: Arial, sans-serif;
    overflow: hidden;
  }
  #app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }
  /* Sidebar */
  .sidebar {
    width: 340px;
    background: #141414;
    border-right: 1px solid #333;
    padding: 20px;
    overflow-y: auto;
  }
  .sidebar h2 {
    margin-top: 0;
  }
  .sidebar label {
    margin-top: 12px;
    display: block;
    font-size: 13px;
    opacity: 0.9;
  }
  .sidebar input,
  .sidebar select {
    width: 100%;
    margin-top: 4px;
    padding: 6px;
    background: #222;
    border: none;
    border-radius: 4px;
    color: #fff;
  }
  hr {
    border: none;
    border-top: 1px solid #333;
    margin: 15px 0;
  }

  /* Main */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
    overflow: auto;
  }
  .stats {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }
  .stat {
    background: #1a1a1a;
    padding: 15px;
    border-radius: 8px;
    min-width: 160px;
  }
  .stat .small {
    font-size: 12px;
    opacity: 0.7;
  }
  #chartWrapper {
    background: #111;
    padding: 10px;
    border-radius: 10px;
    height: 400px;
  }

  /* Modal */
  #detailModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  .modal-content {
    background: #161616;
    border-radius: 8px;
    width: 80%;
    height: 80%;
    padding: 20px;
    position: relative;
    overflow: auto;
  }
  #closeModal {
    position: absolute;
    right: 20px;
    top: 10px;
    cursor: pointer;
    font-size: 20px;
  }
  .modal-section {
    margin-top: 20px;
  }
  canvas {
    background: #000;
  }
  :root {
    --gold: #c9a84b;
  }
</style>
</head>
<body>
<div id="app">
  <div class="sidebar">
    <h2>Configurações de Vendas</h2>

    <label>Percentual Entrada (%)</label>
    <input id="entradaPct" type="number" value="30" />

    <label>Meses de Entrada</label>
    <input id="entradaMonths" type="number" value="6" />

    <label>Parcelas Restantes</label>
    <input id="parcelasRestantes" type="number" value="24" />

    <label>Desconto Pré-Lançamento (%)</label>
    <input id="discountPre" type="number" value="10" />

    <label>Desconto Lançamento (%)</label>
    <input id="discountLaunch" type="number" value="5" />

    <label>Meses Pré-Lançamento</label>
    <input id="preLaunchMonths" type="number" value="2" />

    <label>Meses Lançamento</label>
    <input id="launchMonths" type="number" value="3" />

    <label>INCC Mensal</label>
    <input id="incc" type="number" step="0.0001" value="0.0045" />

    <label>IPCA Mensal</label>
    <input id="ipca" type="number" step="0.0001" value="0.005" />

    <hr />

    <h3>Novas Modalidades</h3>

    <label>Pagamento à Vista (%)</label>
    <input id="payUpfrontPct" type="number" step="0.1" value="0" />

    <label>Pagamento Intermediário (%)</label>
    <input id="payIntermediatePct" type="number" step="0.1" value="0" />

    <label>Número de parcelas intermediárias</label>
    <input id="intermediateMonths" type="number" value="1" />

    <label>Pagamento na Entrega das Chaves (%)</label>
    <input id="payOnDeliveryPct" type="number" value="0" />
  </div>

  <div class="main">
    <div class="stats">
      <div class="stat">
        <div class="small">Receitas</div>
        <div id="totalReceitas" style="font-weight:800;color:var(--gold)">R$ 0</div>
      </div>
      <div class="stat">
        <div class="small">Custos</div>
        <div id="totalCustos" style="font-weight:800;color:var(--gold)">R$ 0</div>
      </div>
      <div class="stat">
        <div class="small">Lucro</div>
        <div id="totalLucro" style="font-weight:800;color:var(--gold)">R$ 0</div>
      </div>
    </div>

    <div id="chartWrapper">
      <canvas id="mainChart"></canvas>
    </div>
  </div>
</div>

<!-- Modal Detalhes -->
<div id="detailModal">
  <div class="modal-content">
    <div id="closeModal">✖</div>

    <div id="modalHeader"></div>

    <div class="modal-section" id="modalSummary"></div>

    <div class="modal-section">
      <canvas id="chartFluxo" height="120"></canvas>
    </div>
    <div class="modal-section">
      <canvas id="chartReceitas" height="120"></canvas>
    </div>
    <div class="modal-section">
      <canvas id="chartCustos" height="120"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ========================
// CONFIGURAÇÃO
// ========================
let saleCfg = {
  entradaPct: 30,
  entradaMonths: 6,
  parcelasRestantes: 24,
  discountPre: 10,
  discountLaunch: 5,
  preLaunchMonths: 2,
  launchMonths: 3,
  incc: 0.0045,
  ipca: 0.005,
  payUpfrontPct: 0,
  payIntermediatePct: 0,
  intermediateMonths: 1,
  payOnDeliveryPct: 0
};

// Inputs salvam no objeto
for (const k in saleCfg) {
  const el = document.getElementById(k);
  if (el) {
    el.value = saleCfg[k];
    el.addEventListener("change", () => {
      saleCfg[k] = Number(el.value);
      calcAll();
    });
  }
}

// ========================
// Funções auxiliares
// ========================
function ensureLen(arr, len) {
  while (arr.length <= len) arr.push(0);
}

// ========================
// Lógica principal de pagamentos
// ========================
function addSalePayments(saleMonth, price_unit, targetArray, cfg, p) {
  const entradaPct = (cfg.entradaPct || 30) / 100;
  const entradaMonths = cfg.entradaMonths || 6;

  const payUpfrontPct = (cfg.payUpfrontPct || 0) / 100;
  const payIntermediatePct = (cfg.payIntermediatePct || 0) / 100;
  const intermediateMonths = cfg.intermediateMonths || 1;
  const payOnDeliveryPct = (cfg.payOnDeliveryPct || 0) / 100;

  const restantePct =
    1 - entradaPct - payUpfrontPct - payIntermediatePct - payOnDeliveryPct;

  const entradaTotal = price_unit * entradaPct;
  const entradaParcel = entradaTotal / entradaMonths;

  const restanteTotal = price_unit * restantePct;
  const restParc = cfg.parcelasRestantes || 24;

  const incc = Number(cfg.incc || 0.0045);
  const ipca = Number(cfg.ipca || 0.004);

  function projCorr(mes) {
    if (mes < p.months)
      return Math.pow(1 + incc, mes - saleMonth);
    return (
      Math.pow(1 + incc, p.months - saleMonth) *
      Math.pow(1 + ipca, mes - p.months)
    );
  }

  // ==============
  // 1) À vista
  // ==============
  if (payUpfrontPct > 0) {
    ensureLen(targetArray, saleMonth);
    targetArray[saleMonth] += price_unit * payUpfrontPct;
  }

  // ==============
  // 2) Entrada parcelada
  // ==============
  for (let m = 0; m < entradaMonths; m++) {
    const idx = saleMonth + m;
    ensureLen(targetArray, idx);
    targetArray[idx] += entradaParcel;
  }

  // ==============
  // 3) Intermediário
  // ==============
  if (payIntermediatePct > 0) {
    const intermediateTotal = price_unit * payIntermediatePct;
    const intermediateParcel = intermediateTotal / intermediateMonths;

    for (let m = 0; m < intermediateMonths; m++) {
      const idx = saleMonth + entradaMonths + m;
      ensureLen(targetArray, idx);
      targetArray[idx] += intermediateParcel;
    }
  }

  // ==============
  // 4) Saldo restante parcelado
  // ==============
  for (let m = 0; m < restParc; m++) {
    const idx =
      saleMonth + entradaMonths + (payIntermediatePct > 0 ? intermediateMonths : 0) + m;
    ensureLen(targetArray, idx);
    targetArray[idx] += restanteTotal / restParc;
  }

  // ==============
  // 5) Pagamento na entrega
  // ==============
  if (payOnDeliveryPct > 0) {
    const lastMonth = p.months - 1;
    ensureLen(targetArray, lastMonth);
    targetArray[lastMonth] += price_unit * payOnDeliveryPct;
  }

  // Correção de projeção (opcional)
  if (cfg.applyProjection === true) {
    for (let i = 0; i < targetArray.length; i++) targetArray[i] *= projCorr(i);
  }
}

// ========================
// Cálculo total
// ========================
function calcAll() {
  const totalMonths = 48;
  const payments = [];
  const price_unit = 100000;
  const p = { months: totalMonths };

  addSalePayments(0, price_unit, payments, saleCfg, p);

  // simples totalizadores
  const totalReceitas = payments.reduce((a, b) => a + b, 0);
  const totalCustos = totalReceitas * 0.25; // placeholder
  const totalLucro = totalReceitas - totalCustos;

  document.getElementById("totalReceitas").textContent = totalReceitas.toLocaleString(
    "pt-BR",
    { style: "currency", currency: "BRL", maximumFractionDigits: 0 }
  );
  document.getElementById("totalCustos").textContent = totalCustos.toLocaleString(
    "pt-BR",
    { style: "currency", currency: "BRL", maximumFractionDigits: 0 }
  );
  document.getElementById("totalLucro").textContent = totalLucro.toLocaleString(
    "pt-BR",
    { style: "currency", currency: "BRL", maximumFractionDigits: 0 }
  );

  // gráfico
  renderChart(payments);
}

let mainChart = null;
function renderChart(series) {
  if (mainChart) mainChart.destroy();
  const ctx = document.getElementById("mainChart").getContext("2d");
  mainChart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: series.map((_, i) => "M" + (i + 1)),
      datasets: [
        {
          label: "Recebimentos",
          data: series,
          backgroundColor: "#c9a84b",
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
    },
  });
}

// ========================
// Modal
// ========================
let modalCharts = { fluxo: null, receitas: null, custos: null };

function destroyModalCharts() {
  for (const k in modalCharts) {
    if (modalCharts[k]) {
      modalCharts[k].destroy();
      modalCharts[k] = null;
    }
  }
}

document.getElementById("closeModal").addEventListener("click", () => {
  destroyModalCharts();
  document.getElementById("detailModal").style.display = "none";
});

// ========================
// Inicializar
// ========================
calcAll();
</script>
</body>
</html>
