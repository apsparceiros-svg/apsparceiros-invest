<!-- Versão revisada, compactada e organizada do seu arquivo -->
<!-- OBS: Mantém funcionalidade, mas reorganiza, corrige bugs estruturais e melhora legibilidade -->
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Simulador Financeiro Revisado</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
  body { background:#f4f4f9; }
  #chart { width:100%; height:400px; }
  .sidebar { width:300px; background:#fff; border-right:1px solid #ddd; padding:15px; height:100vh; overflow:auto; }
  .status-vendas { max-height:200px; overflow:auto; }
</style>
</head>
<body>
<div class="d-flex">
  <div class="sidebar">
    <h4>Configurações</h4>

    <label>Desconto Pré-Lançamento (%)</label>
    <input id="discountPre" type="number" class="form-control mb-2" value="10">

    <label>Desconto Lançamento (%)</label>
    <input id="discountLaunch" type="number" class="form-control mb-2" value="5">

    <label>Entrada (%)</label>
    <input id="entradaPct" type="number" class="form-control mb-2" value="30">

    <label>Meses Entrada</label>
    <input id="entradaMonths" type="number" class="form-control mb-2" value="6">

    <label>Pagamento no ato (%)</label>
    <input id="payAtoPct" type="number" class="form-control mb-2" value="0">

    <label>Pagamento intermediário (%)</label>
    <input id="payInterPct" type="number" class="form-control mb-2" value="0">

    <label>Mês do pagamento intermediário</label>
    <input id="payInterMonth" type="number" class="form-control mb-2" value="6">

    <label>Pagamento na entrega das chaves (%)</label>
    <input id="payChavesPct" type="number" class="form-control mb-2" value="0">

    <label>Parcelas restantes</label>
    <input id="parcelasRestantes" type="number" class="form-control mb-2" value="24">

    <label>INCC mensal (%)</label>
    <input id="incc" type="number" class="form-control mb-2" value="0.45">

    <label>IPCA mensal (%)</label>
    <input id="ipca" type="number" class="form-control mb-2" value="0.50">

    <button class="btn btn-primary mt-2" onclick="simulate()">Simular</button>

    <div class="mt-4">
      <h5>Vendas</h5>
      <button class="btn btn-success btn-sm mb-2" onclick="openCreateSale()">Adicionar Venda</button>
      <div id="saleStatus" class="status-vendas"></div>
    </div>
  </div>

  <div class="flex-grow-1 p-3">
    <h3>Resultados</h3>
    <div id="chart"></div>
    <div id="summary" class="mt-3"></div>
  </div>
</div>

<!-- Modal para criar/editar venda -->
<div class="modal fade" id="ventaModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cadastrar Venda</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <label>Mês da venda</label>
        <input id="saleMonthModal" type="number" class="form-control mb-2">

        <label>Unidade</label>
        <input id="unitNameModal" type="text" class="form-control mb-2">

        <label>Valor</label>
        <input id="unitPriceModal" type="number" class="form-control mb-2">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="saveSaleModal()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<script>
  let saleCfg = {
    discountPre:10,
    discountLaunch:5,
    parcelasRestantes:24,
    entradaPct:30,
    entradaMonths:6,
    payAtoPct:0,
    payInterPct:0,
    payInterMonth:6,
    payChavesPct:0,
    preLaunchMonths:2,
    launchMonths:3,
    incc:0.0045,
    ipca:0.005
  };

  let vendas = [];
  let editingIndex = null;

  function ensureLen(arr, size) {
    while(arr.length < size) arr.push(0);
  }

  function indexar(valor, taxa, meses) {
    return valor * Math.pow(1 + taxa, meses);
  }

  function apply(arr, idx, valor) {
    idx = Math.max(0, idx);
    ensureLen(arr, idx + 1);
    arr[idx] += valor;
  }

  function addSalePayments(saleMonth, price, target, cfg, p) {
    const toPct = v => (v || 0) / 100;

    const pAto = toPct(cfg.payAtoPct);
    const pInter = toPct(cfg.payInterPct);
    const pChaves = toPct(cfg.payChavesPct);
    const pEntrada = toPct(cfg.entradaPct);

    if (price * pAto > 0) apply(target, saleMonth, price * pAto);

    if (price * pInter > 0) apply(target, saleMonth + cfg.payInterMonth, price * pInter);

    if (price * pEntrada > 0) {
      const entradaTotal = price * pEntrada;
      const parcela = entradaTotal / cfg.entradaMonths;
      for (let m = 1; m <= cfg.entradaMonths; m++) {
        apply(target, saleMonth + m, parcela);
      }
    }

    if (price * pChaves > 0) apply(target, p.months, price * pChaves);

    let restantePct = 1 - (pAto + pInter + pChaves + pEntrada);
    if (restantePct < 0) restantePct = 0;

    const saldoTotal = price * restantePct;
    const parcelas = cfg.parcelasRestantes;
    if (parcelas > 0) {
      const parcela = saldoTotal / parcelas;
      for (let m = 0; m < parcelas; m++) {
        apply(target, saleMonth + m, indexar(parcela, cfg.incc, m));
      }
    }
  }

  function simulate() {
    Object.assign(saleCfg, {
      discountPre: Number(discountPre.value),
      discountLaunch: Number(discountLaunch.value),
      entradaPct: Number(entradaPct.value),
      entradaMonths: Number(entradaMonths.value),
      payAtoPct: Number(payAtoPct.value),
      payInterPct: Number(payInterPct.value),
      payInterMonth: Number(payInterMonth.value),
      payChavesPct: Number(payChavesPct.value),
      parcelasRestantes: Number(parcelasRestantes.value),
      incc: Number(incc.value) / 100,
      ipca: Number(ipca.value) / 100
    });

    const months = 48;
    const expenses = new Array(months).fill(0);
    const receipts = new Array(months).fill(0);

    vendas.forEach(v => {
      addSalePayments(v.month, v.price, receipts, saleCfg, { months });
    });

    Plotly.purge('chart');
    Plotly.newPlot('chart', [
      { x:[...receipts.keys()], y:receipts, type:"bar", name:"Receitas" }
    ]);

    summary.innerHTML = `<b>Total Recebido:</b> R$ ${receipts.reduce((a,b)=>a+b,0).toFixed(2)}`;
  }

  function openCreateSale() {
    editingIndex = null;
    saleMonthModal.value = "";
    unitNameModal.value = "";
    unitPriceModal.value = "";
    new bootstrap.Modal(document.getElementById('ventaModal')).show();
  }

  function saveSaleModal() {
    const month = Number(saleMonthModal.value) || 0;
    const name = unitNameModal.value || "Unidade";
    const price = Number(unitPriceModal.value) || 0;

    if (editingIndex !== null) vendas[editingIndex] = {month, name, price};
    else vendas.push({month, name, price});

    updateSaleStatus();
    bootstrap.Modal.getInstance(document.getElementById('ventaModal')).hide();
  }

  function updateSaleStatus() {
    saleStatus.innerHTML = vendas
      .map((v,i)=> `<div>${i+1}) ${v.name} - Mês ${v.month} - R$ ${v.price}</div>`)
      .join("");
  }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
